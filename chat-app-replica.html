<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>聊天应用复刻版</title>
    <style>
        /* 字体定义 */
        @font-face { 
            font-family: 'bulangni'; 
            src: url('') format('truetype'); 
            font-weight: normal; 
            font-style: normal; 
            font-display: swap; 
        }
        
        /* CSS变量定义 */
        :root { 
            --screen-width: 350px; 
            --screen-height: 650px; 
            --secondary-bg: #ffffff; 
            --border-color: #e0e0e0; 
            --text-primary: #1f1f1f; 
            --text-secondary: #8a8a8a; 
            --accent-color: #007bff; 
        }
        
        /* 基础样式重置 */
        html { 
            height: 100%; 
            overflow: hidden; 
        }

        /* 重置 body，使其成为一个干净的画布 */
        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: normal;
            background-color: #f0f2f5; 
        }

        /* 让 #phone-screen 成为新的"根"容器，撑满整个浏览器窗口 */
        #phone-screen {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #000;
        }

        /* 页面切换系统 */
        .screen { 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            opacity: 0; 
            visibility: hidden; 
            transition: opacity 0.3s, visibility 0.3s; 
        }
        
        .screen.active { 
            opacity: 1; 
            visibility: visible; 
            z-index: 1; 
        }

        /* 头部样式 */
        .header { 
            position: relative; 
            z-index: 15; 
            flex-shrink: 0; 
            padding: 15px 20px; 
            padding-top: calc(15px + env(safe-area-inset-top)); 
            background-color: rgba(247, 247, 247, 0.8); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 18px; 
            font-weight: 600; 
        }
        
        .header .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .header .back-btn, .header .action-btn { 
            font-size: 24px; 
            cursor: pointer; 
            width: 30px; 
            text-align: center; 
            color: var(--accent-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        .header .action-btn {
            font-size: 16px;
            font-weight: 600;
        }

        /* 底部导航栏安全区适配 */
        #chat-list-bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 模态框层级 */
        .modal {
            z-index: 1000;
        }

        /* 聊天列表视图样式 */
        .chat-list-view {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        .chat-list-view.active {
            display: block;
        }

        /* 聊天列表背景层 */
        .chat-list-bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 0;
        }

        /* 聊天列表容器 */
        #chat-list {
            flex-grow: 1;
            background-color: transparent;
            padding-top: 80px; 
            padding-bottom: 50px;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
            overflow-y: auto;
        }

        /* 主聊天列表header布局调整 */
        #main-chat-list-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-left: 70px; /* 为左侧头像预留空间 */
            padding-right: 20px;
        }
        
        /* 用户头像样式 */
        .user-avatar-container {
            position: absolute;
            top: 40px;
            left: 18px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.2s ease;
            background-color: #f0f0f0;
        }
        
        .user-avatar:hover {
            border-color: var(--accent-color);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        .user-avatar:active {
            transform: scale(0.95);
        }
        
        /* 群聊/单聊切换开关样式 - 绝对居中 */
        .chat-type-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 16px;
            padding: 2px;
            max-width: 180px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .toggle-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            min-width: 36px;
            white-space: nowrap;
        }

        .toggle-btn.active {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .toggle-btn:hover:not(.active) {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }
        
        /* 右侧操作区域 */
        #main-chat-list-header .header-actions {
            margin-left: auto;
        }
        
        /* 下拉菜单样式 */
        .user-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
        }
        
        .user-dropdown-menu.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }
        
        .dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item svg {
            margin-right: 12px;
            color: var(--accent-color);
            flex-shrink: 0;
        }
        
        .dropdown-item span {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        /* 添加菜单容器样式 */
        .add-menu-container {
            position: relative;
        }
        
        /* 添加菜单下拉样式 */
        .add-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
        }
        
        .add-dropdown-menu.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* 聊天列表项样式 */
        .chat-list-item { 
            display: flex; 
            align-items: center; 
            padding: 10px 15px; 
            cursor: pointer; 
            border-bottom: 1px solid var(--border-color); 
            position: relative;
            transition: all 0.2s ease;
            background-color: transparent;
        }
        
        .chat-list-item:hover { 
            background-color: rgba(0, 0, 0, 0.04);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .chat-list-item .avatar { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            margin-right: 12px; 
            object-fit: cover; 
            background-color: #ccc; 
        }
        
        .chat-list-item .info { 
            flex-grow: 1; 
            overflow: hidden; 
        }
        
        .chat-list-item .name-line { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            margin-bottom: 2px; 
        }
        
        .chat-list-item .name {
            font-weight: 700 !important;
            color: #ee0606 !important;
            text-shadow: 0 1px 4px rgba(255,255,255,0.85), 0 0 2px rgba(0,0,0,0.12) !important;
            letter-spacing: 0.5px !important;
            font-size: 16px !important;
        }
        
        .chat-list-item .group-tag { 
            font-size: 10px; 
            color: var(--accent-color); 
            background-color: #e7f3ff; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: bold; 
            flex-shrink: 0; 
        }
        
        .chat-list-item .last-msg { 
            font-size: 13px; 
            color: var(--text-secondary); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 180px; 
        }
        
        .unread-count-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }
        
        .unread-count {
            background-color: #ff3b30;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
            line-height: 1.2;
        }

        /* 底部导航栏基础样式 */
        #chat-list-bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 10;
        }
        
        /* 导航项样式 */
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 0 4px;
        }
        
        .nav-item:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .nav-item span {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }
        
        .nav-item.active span {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .nav-item.active {
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        /* 通用列表容器样式 */
        .list-container {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* 聊天界面样式 */
        #chat-interface-screen {
            background-color: #f5f5f5;
        }
        
        /* 聊天界面头部 */
        #chat-interface-header {
            background-color: rgba(247, 247, 247, 0.95);
            border-bottom: 1px solid var(--border-color);
        }
        
        .chat-info {
            flex-grow: 1;
            text-align: center;
            margin: 0 20px;
        }
        
        .chat-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .chat-status {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* 消息显示区域 */
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #f5f5f5;
        }
        
        /* 消息气泡基础样式 */
        .message-wrapper {
            display: flex;
            max-width: 80%;
            gap: 8px;
            align-items: flex-end;
        }
        
        .message-wrapper.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message-wrapper.ai {
            align-self: flex-start;
        }
        
        .message-bubble {
            background-color: white;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 100%;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .message-wrapper.user .message-bubble {
            background-color: var(--accent-color);
            color: white;
        }
        
        .message-wrapper.ai .message-bubble {
            background-color: white;
            color: var(--text-primary);
        }
        
        .message-timestamp {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
            white-space: nowrap;
        }
        
        /* 聊天输入区域 */
        .chat-input-area {
            flex-shrink: 0;
            padding: 15px;
            background-color: rgba(247, 247, 247, 0.95);
            border-top: 1px solid var(--border-color);
        }
        
        .chat-input-main-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        
        .chat-input {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 16px;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            height: 40px;
            background-color: white;
            outline: none;
            font-family: inherit;
            line-height: 1.4;
            overflow-y: auto;
            transition: height 0.2s ease;
        }
        
        .chat-input:focus {
            border-color: var(--accent-color);
        }
        
        .send-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }
        
        .send-btn:hover {
            background-color: #0056b3;
        }
        
        .send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* 聊天功能按钮区域 */
        .chat-input-actions {
            display: none;
            gap: 10px;
            padding: 10px 0;
            flex-wrap: wrap;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .chat-input-actions.visible {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        
        .chat-action-btn {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .chat-action-btn:hover {
            background: linear-gradient(145deg, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0.8));
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .chat-action-btn:active {
            transform: scale(0.95);
        }
        
        .toggle-actions-btn {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-color);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        .toggle-actions-btn:hover {
            background: linear-gradient(145deg, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0.8));
            transform: scale(1.05);
        }
        
        .toggle-actions-btn.expanded {
            transform: rotate(45deg);
            background: linear-gradient(145deg, rgba(0, 123, 255, 0.9), rgba(0, 123, 255, 0.7));
            color: white;
        }
        
        .toggle-actions-btn.expanded:hover {
            transform: rotate(45deg) scale(1.05);
        }
        
        /* 表单容器样式 */
        .form-container {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: white;
            transition: border-color 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-group input[type="range"] {
            width: calc(100% - 60px);
            margin-right: 10px;
        }
        
        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        .form-button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.2s ease;
        }
        
        .form-button:hover {
            background-color: #0056b3;
        }
        
        .form-button-secondary {
            background-color: #f0f0f0;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .form-button-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .api-status {
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }
        
        .api-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .api-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .api-status.loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* 外观设置页面样式 */
        .theme-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .theme-selector label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .theme-selector label:hover {
            background-color: #f8f9fa;
        }
        
        .theme-selector input[type="radio"] {
            margin-right: 10px;
            width: auto;
        }
        
        .wallpaper-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: border-color 0.2s ease;
            margin-bottom: 10px;
        }
        
        .wallpaper-preview:hover {
            border-color: var(--accent-color);
        }
        
        .wallpaper-preview span {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .wallpaper-actions {
            display: flex;
            gap: 10px;
        }
        
        .wallpaper-actions button {
            flex: 1;
            margin-bottom: 0;
        }
        
        .bubble-style-selector {
            display: flex;
            gap: 15px;
            justify-content: space-around;
        }
        
        .bubble-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 15px;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .bubble-option:hover {
            background-color: #f8f9fa;
        }
        
        .bubble-option.active {
            border-color: var(--accent-color);
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .bubble-preview {
            width: 40px;
            height: 25px;
            background-color: var(--accent-color);
            margin-bottom: 8px;
        }
        
        .bubble-rounded {
            border-radius: 15px;
        }
        
        .bubble-normal {
            border-radius: 8px;
        }
        
        .bubble-square {
            border-radius: 3px;
        }
        
        .bubble-option span {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .appearance-status {
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }
        
        .appearance-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .appearance-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* 字体设置页面样式 */
        .font-preview {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            background-color: white;
            margin-bottom: 20px;
        }
        
        .preview-text h3 {
            margin: 0 0 15px 0;
            color: var(--text-primary);
        }
        
        .preview-text p {
            margin: 0 0 10px 0;
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .preview-chat {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .preview-message {
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .preview-message.user {
            background-color: var(--accent-color);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .preview-message.ai {
            background-color: #f0f0f0;
            color: var(--text-primary);
            margin-right: auto;
        }
        
        .font-status {
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }
        
        .font-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .font-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* 字体平滑样式 */
        .font-smoothing {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* 世界书页面样式 */
        .world-book-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .world-book-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid var(--accent-color);
        }
        
        .world-book-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .world-book-item.disabled {
            opacity: 0.6;
            border-left-color: #ccc;
        }
        
        .world-book-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .world-book-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .world-book-priority {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .priority-high {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .priority-medium {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .priority-low {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .world-book-keywords {
            margin-bottom: 10px;
        }
        
        .keyword-tag {
            display: inline-block;
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .world-book-preview {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .empty-world-books {
            text-align: center;
            padding: 50px 20px;
        }
        
        /* 聊天历史页面样式 */
        .search-container {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .search-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-input-wrapper input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        
        .search-input-wrapper input:focus {
            border-color: var(--accent-color);
        }
        
        .search-input-wrapper button {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 14px;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        .filter-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 0 15px;
        }
        
        .filter-tab {
            flex: 1;
            padding: 12px 0;
            background: none;
            border: none;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .filter-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .chat-history-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        
        .history-item {
            background: white;
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .history-item:hover {
            background-color: #f8f9fa;
        }
        
        .history-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .history-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .history-item-info {
            flex-grow: 1;
        }
        
        .history-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .history-item-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .history-item-stats {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: right;
        }
        
        .history-item-preview {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .empty-history {
            text-align: center;
            padding: 50px 20px;
        }
        
        /* 历史记录详情页面样式 */
        .history-detail-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
        }
        
        .history-info {
            display: flex;
            align-items: center;
            padding: 20px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .history-avatar-container {
            margin-right: 15px;
        }
        
        .history-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
        }
        
        .history-meta h3 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
            font-size: 18px;
        }
        
        .history-meta p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .history-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .history-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .history-message.user {
            flex-direction: row-reverse;
        }
        
        .history-message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 0 10px;
            flex-shrink: 0;
        }
        
        .history-message-content {
            max-width: 70%;
            background: white;
            padding: 10px 15px;
            border-radius: 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .history-message.user .history-message-content {
            background: var(--accent-color);
            color: white;
        }
        
        .history-message-text {
            margin: 0;
            line-height: 1.4;
        }
        
        .history-message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: center;
        }
        
        .history-message.user .history-message-time {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* 动态页面样式 */
        #qzone-screen {
            background-color: #f5f5f5;
        }
        
        .qzone-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
        }
        
        .qzone-profile-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .qzone-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .qzone-avatar-container {
            position: relative;
        }
        
        .qzone-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
        }
        
        .qzone-user-details h2 {
            margin: 0 0 5px 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        .qzone-user-details p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .qzone-stats {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: 600;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* 发布动态区域 */
        .qzone-post-area {
            background: white;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .post-input-container {
            display: flex;
            gap: 12px;
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .post-input-wrapper {
            flex-grow: 1;
        }
        
        #post-content-input {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        #post-content-input:focus {
            border-color: var(--accent-color);
        }
        
        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .post-tools {
            display: flex;
            gap: 10px;
        }
        
        .post-tool-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .post-tool-btn:hover {
            background-color: #f8f9fa;
            border-color: var(--accent-color);
        }
        
        .post-submit-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .post-submit-btn:hover {
            background-color: #0056b3;
        }
        
        .post-submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* 动态内容区域 */
        .qzone-content {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f5f5f5;
        }
        
        .posts-list {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .empty-posts {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }
        
        .empty-posts p {
            margin: 0;
            font-size: 14px;
        }
        
        /* 动态项样式 */
        .post-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .post-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .post-author-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .post-author-info {
            flex-grow: 1;
        }
        
        .post-author-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin: 0 0 2px 0;
        }
        
        .post-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .post-content {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 12px;
            white-space: pre-wrap;
        }
        
        .post-actions-bar {
            display: flex;
            justify-content: space-around;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }
        
        .post-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .post-action-btn:hover {
            background-color: #f8f9fa;
            color: var(--text-primary);
        }
        
        .post-action-btn.liked {
            color: #ff3b30;
        }
    </style>
</head>
<body>
    <!-- 主容器 -->
    <div id="phone-screen">
        <!-- 聊天列表主页面 -->
        <div id="chat-list-screen" class="screen active">
            <!-- 头部区域 -->
            <div class="header" id="main-chat-list-header">
                <!-- 用户头像容器 -->
                <div class="user-avatar-container" id="user-avatar-container">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='%23ccc'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="用户头像" id="user-avatar" class="user-avatar">
                    
                    <!-- 下拉设置菜单 -->
                    <div class="user-dropdown-menu" id="user-dropdown-menu">
                        <div class="dropdown-item" id="dropdown-api-settings">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M19.4 15C19.2669 15.3016 19.2272 15.6362 19.286 15.9606C19.3448 16.285 19.4995 16.5843 19.73 16.82L19.79 16.88C19.976 17.0657 20.1235 17.2863 20.2241 17.5291C20.3248 17.7719 20.3766 18.0322 20.3766 18.295C20.3766 18.5578 20.3248 18.8181 20.2241 19.0609C20.1235 19.3037 19.976 19.5243 19.79 19.71C19.6043 19.896 19.3837 20.0435 19.1409 20.1441C18.8981 20.2448 18.6378 20.2966 18.375 20.2966C18.1122 20.2966 17.8519 20.2448 17.6091 20.1441C17.3663 20.0435 17.1457 19.896 16.96 19.71L16.9 19.65C16.6643 19.4195 16.365 19.2648 16.0406 19.206C15.7162 19.1472 15.3816 19.1869 15.08 19.32C14.7842 19.4468 14.532 19.6572 14.3543 19.9255C14.1766 20.1938 14.0813 20.5082 14.08 20.83V21C14.08 21.5304 13.8693 22.0391 13.4942 22.4142C13.1191 22.7893 12.6104 23 12.08 23C11.5496 23 11.0409 22.7893 10.6658 22.4142C10.2907 22.0391 10.08 21.5304 10.08 21V20.91C10.0723 20.579 9.96512 20.2579 9.77251 19.9887C9.5799 19.7194 9.31074 19.5143 9 19.4C8.69838 19.2669 8.36381 19.2272 8.03941 19.286C7.71502 19.3448 7.41568 19.4995 7.18 19.73L7.12 19.79C6.93425 19.976 6.71368 20.1235 6.47088 20.2241C6.22808 20.3248 5.96783 20.3766 5.705 20.3766C5.44217 20.3766 5.18192 20.3248 4.93912 20.2241C4.69632 20.1235 4.47575 19.976 4.29 19.79C4.10405 19.6043 3.95653 19.3837 3.85588 19.1409C3.75523 18.8981 3.70343 18.6378 3.70343 18.375C3.70343 18.1122 3.75523 17.8519 3.85588 17.6091C3.95653 17.3663 4.10405 17.1457 4.29 16.96L4.35 16.9C4.58054 16.6643 4.73519 16.365 4.794 16.0406C4.85282 15.7162 4.81312 15.3816 4.68 15.08C4.55324 14.7842 4.34276 14.532 4.07447 14.3543C3.80618 14.1766 3.49179 14.0813 3.17 14.08H3C2.46957 14.08 1.96086 13.8693 1.58579 13.4942C1.21071 13.1191 1 12.6104 1 12.08C1 11.5496 1.21071 11.0409 1.58579 10.6658C1.96086 10.2907 2.46957 10.08 3 10.08H3.09C3.42099 10.0723 3.742 9.96512 4.01127 9.77251C4.28054 9.5799 4.48571 9.31074 4.6 9C4.73312 8.69838 4.77282 8.36381 4.714 8.03941C4.65519 7.71502 4.50054 7.41568 4.27 7.18L4.21 7.12C4.02405 6.93425 3.87653 6.71368 3.77588 6.47088C3.67523 6.22808 3.62343 5.96783 3.62343 5.705C3.62343 5.44217 3.67523 5.18192 3.77588 4.93912C3.87653 4.69632 4.02405 4.47575 4.21 4.29C4.39575 4.10405 4.61632 3.95653 4.85912 3.85588C5.10192 3.75523 5.36217 3.70343 5.625 3.70343C5.88783 3.70343 6.14808 3.75523 6.39088 3.85588C6.63368 3.95653 6.85425 4.10405 7.04 4.29L7.1 4.35C7.33568 4.58054 7.63502 4.73519 7.95941 4.794C8.28381 4.85282 8.61838 4.81312 8.92 4.68H9C9.29577 4.55324 9.54802 4.34276 9.72569 4.07447C9.90337 3.80618 9.99872 3.49179 10 3.17V3C10 2.46957 10.2107 1.96086 10.5858 1.58579C10.9609 1.21071 11.4696 1 12 1C12.5304 1 13.0391 1.21071 13.4142 1.58579C13.7893 1.96086 14 2.46957 14 3V3.09C14.0013 3.41179 14.0966 3.72618 14.2743 3.99447C14.452 4.26276 14.7042 4.47324 15 4.6C15.3016 4.73312 15.6362 4.77282 15.9606 4.714C16.285 4.65519 16.5843 4.50054 16.82 4.27L16.88 4.21C17.0657 4.02405 17.2863 3.87653 17.5291 3.77588C17.7719 3.67523 18.0322 3.62343 18.295 3.62343C18.5578 3.62343 18.8181 3.67523 19.0609 3.77588C19.3037 3.87653 19.5243 4.02405 19.71 4.21C19.896 4.39575 20.0435 4.61632 20.1441 4.85912C20.2448 5.10192 20.2966 5.36217 20.2966 5.625C20.2966 5.88783 20.2448 6.14808 20.1441 6.39088C20.0435 6.63368 19.896 6.85425 19.71 7.04L19.65 7.1C19.4195 7.33568 19.2648 7.63502 19.206 7.95941C19.1472 8.28381 19.1869 8.61838 19.32 8.92V9C19.4468 9.29577 19.6572 9.54802 19.9255 9.72569C20.1938 9.90337 20.5082 9.99872 20.83 10H21C21.5304 10 22.0391 10.2107 22.4142 10.5858C22.7893 10.9609 23 11.4696 23 12C23 12.5304 22.7893 13.0391 22.4142 13.4142C22.0391 13.7893 21.5304 14 21 14H20.91C20.5882 14.0013 20.2738 14.0966 20.0055 14.2743C19.7372 14.452 19.5268 14.7042 19.4 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>API设置</span>
                        </div>
                        <div class="dropdown-item" id="dropdown-appearance-settings">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2V6M12 18V22M4.93 4.93L7.76 7.76M16.24 16.24L19.07 19.07M2 12H6M18 12H22M4.93 19.07L7.76 16.24M16.24 7.76L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>外观设置</span>
                        </div>
                        <div class="dropdown-item" id="dropdown-font-settings">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 7V4H20V7M9 20H15M12 4V20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>字体设置</span>
                        </div>
                        <div class="dropdown-item" id="dropdown-world-book">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 19.5C4 18.837 4.26339 18.2011 4.73223 17.7322C5.20107 17.2634 5.83696 17 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M6.5 2H20V22H6.5C5.83696 22 5.20107 21.7366 4.73223 21.2678C4.26339 20.7989 4 20.163 4 19.5V4.5C4 3.83696 4.26339 3.20107 4.73223 2.73223C5.20107 2.26339 5.83696 2 6.5 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>世界书</span>
                        </div>
                        <div class="dropdown-item" id="dropdown-memories" data-view="memories-view">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>回忆</span>
                        </div>
                        <div class="dropdown-item" id="dropdown-favorites" data-view="favorites-view">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>收藏</span>
                        </div>
                        <div class="dropdown-item" id="dropdown-change-avatar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>更换头像</span>
                        </div>
                        <div class="dropdown-item" id="dropdown-chat-list-bg">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none"/>
                                <circle cx="8.5" cy="8.5" r="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                                <path d="M21 15L16 10L5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>聊天背景</span>
                        </div>
                    </div>
                </div>
                
                <!-- 群聊/单聊切换开关 - 绝对居中 -->
                <div class="chat-type-toggle" id="chat-type-toggle">
                    <button class="toggle-btn active" data-type="all" id="toggle-all">全部</button>
                    <button class="toggle-btn" data-type="single" id="toggle-single">单聊</button>
                    <button class="toggle-btn" data-type="group" id="toggle-group">群聊</button>
                </div>
                
                <!-- 右侧操作区域 -->
                <div class="header-actions">
                    <div class="add-menu-container">
                        <span class="action-btn" id="add-menu-btn">+</span>
                        <div class="add-dropdown-menu" id="add-dropdown-menu">
                            <div class="dropdown-item" id="add-friend-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 21V19C16 17.9391 15.5786 16.9217 14.8284 16.1716C14.0783 15.4214 13.0609 15 12 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="8.5" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <line x1="20" y1="8" x2="20" y2="14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <line x1="17" y1="11" x2="23" y2="11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>添加好友</span>
                            </div>
                            <div class="dropdown-item" id="add-group-chat-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 1.17157 16.1716C0.421427 16.9217 0 17.9391 0 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M23 21V19C23 18.1645 22.7155 17.3541 22.2094 16.6977C21.7033 16.0413 20.9983 15.5759 20.2 15.37" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89317 18.7122 8.75608 18.1676 9.45768C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>创建群聊</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 消息列表视图 -->
            <div id="messages-view" class="chat-list-view active">
                <!-- 背景壁纸层 -->
                <div class="chat-list-bg-layer" id="chat-list-bg-layer"></div>
                
                <!-- 聊天列表容器 -->
                <div id="chat-list">
                    <!-- 聊天列表项将由JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 收藏视图 -->
            <div id="favorites-view" class="chat-list-view">
                <div class="list-container">
                    <p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                        收藏功能将在后续任务中实现
                    </p>
                </div>
            </div>
            
            <!-- 回忆视图 -->
            <div id="memories-view" class="chat-list-view">
                <div class="list-container">
                    <p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                        回忆功能将在后续任务中实现
                    </p>
                </div>
            </div>
            
            <!-- 底部导航栏 -->
            <div id="chat-list-bottom-nav">
                <div class="nav-item active" data-view="messages-view">
                    <span>消息</span>
                </div>
                <div class="nav-item" data-view="qzone-screen">
                    <span>动态</span>
                </div>
                <div class="nav-item" data-view="call-history-screen">
                    <span>聊天历史</span>
                </div>
            </div>
        </div>
        
        <!-- 聊天对话页面 -->
        <div id="chat-interface-screen" class="screen">
            <!-- 聊天界面头部导航栏 -->
            <div class="header" id="chat-interface-header">
                <div class="default-controls">
                    <span class="back-btn" id="chat-back-btn">‹</span>
                    <div class="chat-info">
                        <div class="chat-name" id="chat-interface-name">聊天名称</div>
                        <div class="chat-status" id="chat-interface-status">在线</div>
                    </div>
                    <div class="header-actions">
                        <span class="action-btn" id="chat-settings-btn">⚙</span>
                    </div>
                </div>
            </div>
            
            <!-- 消息显示区域 -->
            <div id="chat-messages" class="chat-messages">
                <!-- 消息将在这里动态生成 -->
                <div class="welcome-message">
                    <p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                        开始聊天吧！
                    </p>
                </div>
            </div>
            
            <!-- 聊天输入区域 -->
            <div id="chat-input-area" class="chat-input-area">
                <!-- 功能按钮区域 -->
                <div id="chat-input-actions" class="chat-input-actions">
                    <button id="emoji-btn" class="chat-action-btn" title="表情">😊</button>
                    <button id="image-btn" class="chat-action-btn" title="图片">📷</button>
                    <button id="file-btn" class="chat-action-btn" title="文件">📎</button>
                    <button id="voice-btn" class="chat-action-btn" title="语音">🎤</button>
                </div>
                
                <div id="chat-input-main-row" class="chat-input-main-row">
                    <button id="toggle-actions-btn" class="toggle-actions-btn" title="更多功能">+</button>
                    <textarea id="chat-input" class="chat-input" placeholder="输入消息..." rows="1"></textarea>
                    <button id="send-btn" class="action-button send-btn">发送</button>
                </div>
            </div>
        </div>
        
        <!-- API设置页面 -->
        <div id="api-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn">‹</span>
                <span>API 设置</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label for="api-provider">API 提供商</label>
                    <select id="api-provider">
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="google">Google AI</option>
                        <option value="local">本地模型</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="api-key">API 密钥</label>
                    <input type="password" id="api-key" placeholder="请输入您的API密钥">
                </div>
                
                <div class="form-group">
                    <label for="api-model">模型选择</label>
                    <select id="api-model">
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="claude-3">Claude 3</option>
                        <option value="gemini-pro">Gemini Pro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="api-base-url">API 基础URL（可选）</label>
                    <input type="url" id="api-base-url" placeholder="https://api.openai.com/v1">
                </div>
                
                <div class="form-group">
                    <label for="max-tokens">最大令牌数</label>
                    <input type="number" id="max-tokens" value="2000" min="100" max="8000">
                </div>
                
                <div class="form-group">
                    <label for="temperature">温度（创造性）</label>
                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                    <span id="temperature-value">0.7</span>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="stream-response"> 流式响应
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enable-vision"> 启用视觉功能（支持图片）
                    </label>
                </div>
                
                <button class="form-button" id="test-api-btn">测试连接</button>
                <button class="form-button" id="save-api-settings-btn">保存设置</button>
                <button class="form-button form-button-secondary" id="reset-api-settings-btn">重置为默认</button>
                
                <div class="api-status" id="api-status" style="margin-top: 20px; padding: 10px; border-radius: 8px; display: none;">
                    <span id="api-status-text"></span>
                </div>
            </div>
        </div>
        
        <!-- 外观设置页面 -->
        <div id="wallpaper-screen" class="screen">
            <div class="header">
                <span class="back-btn">‹</span>
                <span>外观设置</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <!-- 主题设置 -->
                <div class="form-group">
                    <label>主题模式</label>
                    <div class="theme-selector">
                        <label>
                            <input type="radio" name="theme" value="light" id="theme-light" checked>
                            <span>浅色模式</span>
                        </label>
                        <label>
                            <input type="radio" name="theme" value="dark" id="theme-dark">
                            <span>深色模式</span>
                        </label>
                        <label>
                            <input type="radio" name="theme" value="auto" id="theme-auto">
                            <span>跟随系统</span>
                        </label>
                    </div>
                </div>
                
                <!-- 背景壁纸设置 -->
                <div class="form-group">
                    <label for="wallpaper-upload">聊天背景壁纸</label>
                    <div id="wallpaper-preview" class="wallpaper-preview">
                        <span>点击选择背景图片</span>
                    </div>
                    <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;">
                    <div class="wallpaper-actions">
                        <button type="button" class="form-button form-button-secondary" id="select-wallpaper-btn">选择图片</button>
                        <button type="button" class="form-button form-button-secondary" id="remove-wallpaper-btn">移除背景</button>
                    </div>
                </div>
                
                <!-- 背景透明度 -->
                <div class="form-group">
                    <label for="wallpaper-opacity">背景透明度</label>
                    <input type="range" id="wallpaper-opacity" min="0" max="100" value="80" step="5">
                    <span id="wallpaper-opacity-value">80%</span>
                </div>
                
                <!-- 聊天气泡样式 -->
                <div class="form-group">
                    <label>聊天气泡样式</label>
                    <div class="bubble-style-selector">
                        <div class="bubble-option" data-style="rounded">
                            <div class="bubble-preview bubble-rounded"></div>
                            <span>圆角</span>
                        </div>
                        <div class="bubble-option active" data-style="normal">
                            <div class="bubble-preview bubble-normal"></div>
                            <span>标准</span>
                        </div>
                        <div class="bubble-option" data-style="square">
                            <div class="bubble-preview bubble-square"></div>
                            <span>方形</span>
                        </div>
                    </div>
                </div>
                
                <!-- 字体大小 -->
                <div class="form-group">
                    <label for="font-size">字体大小</label>
                    <input type="range" id="font-size" min="12" max="20" value="14" step="1">
                    <span id="font-size-value">14px</span>
                </div>
                
                <!-- 紧凑模式 -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="compact-mode"> 紧凑模式
                    </label>
                    <small style="color: var(--text-secondary); margin-left: 24px;">减少界面元素间距，显示更多内容</small>
                </div>
                
                <!-- 动画效果 -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enable-animations" checked> 启用动画效果
                    </label>
                    <small style="color: var(--text-secondary); margin-left: 24px;">页面切换和交互动画</small>
                </div>
                
                <button class="form-button" id="save-appearance-settings-btn">保存设置</button>
                <button class="form-button form-button-secondary" id="reset-appearance-settings-btn">重置为默认</button>
                
                <div class="appearance-status" id="appearance-status" style="margin-top: 20px; padding: 10px; border-radius: 8px; display: none;">
                    <span id="appearance-status-text"></span>
                </div>
            </div>
        </div>
        
        <!-- 字体设置页面 -->
        <div id="font-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn">‹</span>
                <span>字体设置</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <!-- 字体预览 -->
                <div class="form-group">
                    <label>字体预览</label>
                    <div class="font-preview" id="font-preview">
                        <div class="preview-text">
                            <h3>标题文字 Title Text</h3>
                            <p>这是一段中文预览文字，用于展示字体效果。</p>
                            <p>This is English preview text to show font effects.</p>
                            <div class="preview-chat">
                                <div class="preview-message user">你好！这是用户消息</div>
                                <div class="preview-message ai">你好！这是AI回复消息</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 字体族选择 -->
                <div class="form-group">
                    <label for="font-family">字体族</label>
                    <select id="font-family">
                        <option value="system">系统默认</option>
                        <option value="serif">衬线字体 (Serif)</option>
                        <option value="sans-serif">无衬线字体 (Sans-serif)</option>
                        <option value="monospace">等宽字体 (Monospace)</option>
                        <option value="cursive">手写字体 (Cursive)</option>
                        <option value="fantasy">装饰字体 (Fantasy)</option>
                    </select>
                </div>
                
                <!-- 自定义字体URL -->
                <div class="form-group">
                    <label for="custom-font-url">自定义字体URL（可选）</label>
                    <input type="url" id="custom-font-url" placeholder="https://fonts.googleapis.com/css2?family=...">
                    <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                        支持Google Fonts等在线字体服务
                    </small>
                </div>
                
                <!-- 字体大小 -->
                <div class="form-group">
                    <label for="font-size-setting">字体大小</label>
                    <input type="range" id="font-size-setting" min="10" max="24" value="14" step="1">
                    <span id="font-size-setting-value">14px</span>
                </div>
                
                <!-- 行高 -->
                <div class="form-group">
                    <label for="line-height">行高</label>
                    <input type="range" id="line-height" min="1.0" max="2.0" value="1.4" step="0.1">
                    <span id="line-height-value">1.4</span>
                </div>
                
                <!-- 字重 -->
                <div class="form-group">
                    <label for="font-weight">字重</label>
                    <select id="font-weight">
                        <option value="300">细体 (Light)</option>
                        <option value="400" selected>正常 (Normal)</option>
                        <option value="500">中等 (Medium)</option>
                        <option value="600">半粗 (Semi-bold)</option>
                        <option value="700">粗体 (Bold)</option>
                    </select>
                </div>
                
                <!-- 字间距 -->
                <div class="form-group">
                    <label for="letter-spacing">字间距</label>
                    <input type="range" id="letter-spacing" min="-0.05" max="0.1" value="0" step="0.01">
                    <span id="letter-spacing-value">0em</span>
                </div>
                
                <!-- 聊天消息字体大小 -->
                <div class="form-group">
                    <label for="message-font-size">聊天消息字体大小</label>
                    <input type="range" id="message-font-size" min="12" max="20" value="14" step="1">
                    <span id="message-font-size-value">14px</span>
                </div>
                
                <!-- 界面字体大小 -->
                <div class="form-group">
                    <label for="ui-font-size">界面字体大小</label>
                    <input type="range" id="ui-font-size" min="11" max="18" value="13" step="1">
                    <span id="ui-font-size-value">13px</span>
                </div>
                
                <!-- 字体平滑 -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="font-smoothing" checked> 启用字体平滑
                    </label>
                    <small style="color: var(--text-secondary); margin-left: 24px;">改善字体在屏幕上的显示效果</small>
                </div>
                
                <button class="form-button" id="save-font-settings-btn">保存设置</button>
                <button class="form-button form-button-secondary" id="reset-font-settings-btn">重置为默认</button>
                
                <div class="font-status" id="font-status" style="margin-top: 20px; padding: 10px; border-radius: 8px; display: none;">
                    <span id="font-status-text"></span>
                </div>
            </div>
        </div>
        
        <!-- 世界书页面 -->
        <div id="world-book-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="world-book-back-btn">‹</span>
                <span>世界书</span>
                <span class="action-btn" id="add-world-book-btn">+</span>
            </div>
            <div class="list-container">
                <!-- 世界书列表 -->
                <div id="world-book-list" class="world-book-list">
                    <!-- 世界书条目将在这里动态生成 -->
                    <div class="empty-world-books">
                        <p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                            还没有世界书条目，点击右上角 + 号添加
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 世界书编辑页面 -->
        <div id="world-book-editor-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="world-book-editor-back-btn">‹</span>
                <span id="world-book-editor-title">新建世界书</span>
                <span class="action-btn" id="save-world-book-btn">保存</span>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label for="world-book-name-input">条目名称</label>
                    <input type="text" id="world-book-name-input" placeholder="请输入条目名称">
                </div>
                
                <div class="form-group">
                    <label for="world-book-keywords-input">关键词（用逗号分隔）</label>
                    <input type="text" id="world-book-keywords-input" placeholder="例如：角色名,地点名,物品名">
                    <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                        当聊天中出现这些关键词时，会自动引用此条目
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="world-book-content-input">条目内容</label>
                    <textarea id="world-book-content-input" placeholder="请输入详细的背景信息、设定等..." rows="10"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="world-book-priority">优先级</label>
                    <select id="world-book-priority">
                        <option value="1">低</option>
                        <option value="2" selected>中</option>
                        <option value="3">高</option>
                    </select>
                    <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                        优先级高的条目会优先被引用
                    </small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="world-book-enabled" checked> 启用此条目
                    </label>
                </div>
                
                <button class="form-button" id="delete-world-book-btn" style="background-color: #ff3b30; display: none;">删除条目</button>
            </div>
        </div>
        
        <!-- 动态页面 -->
        <div id="qzone-screen" class="screen">
            <!-- 动态页面头部 -->
            <div class="qzone-header">
                <div class="qzone-profile-section">
                    <!-- 用户信息 -->
                    <div class="qzone-user-info">
                        <div class="qzone-avatar-container">
                            <img id="qzone-user-avatar" class="qzone-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 24 24' fill='%23007bff'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="用户头像">
                        </div>
                        <div class="qzone-user-details">
                            <h2 id="qzone-user-name">我的昵称</h2>
                            <p id="qzone-user-status">今天心情不错 😊</p>
                        </div>
                    </div>
                    
                    <!-- 统计信息 -->
                    <div class="qzone-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="posts-count">0</span>
                            <span class="stat-label">动态</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="friends-count">0</span>
                            <span class="stat-label">好友</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="visits-count">0</span>
                            <span class="stat-label">访问</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 发布动态区域 -->
            <div class="qzone-post-area">
                <div class="post-input-container">
                    <img class="post-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24' fill='%23007bff'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="头像">
                    <div class="post-input-wrapper">
                        <textarea id="post-content-input" placeholder="分享新鲜事..." rows="3"></textarea>
                        <div class="post-actions">
                            <div class="post-tools">
                                <button class="post-tool-btn" id="post-image-btn" title="添加图片">📷</button>
                                <button class="post-tool-btn" id="post-emoji-btn" title="添加表情">😊</button>
                                <button class="post-tool-btn" id="post-location-btn" title="添加位置">📍</button>
                            </div>
                            <button class="post-submit-btn" id="publish-post-btn">发布</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 动态列表 -->
            <div class="qzone-content">
                <div id="qzone-posts-list" class="posts-list">
                    <!-- 动态列表项将在这里动态生成 -->
                    <div class="empty-posts">
                        <p>还没有动态，快来发布第一条吧！</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 聊天历史页面 -->
        <div id="call-history-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="chat-history-back-btn">‹</span>
                <span>聊天历史</span>
                <div class="header-actions">
                    <span class="action-btn" id="search-history-btn">🔍</span>
                    <span class="action-btn" id="clear-history-btn">🗑️</span>
                </div>
            </div>
            
            <!-- 搜索栏 -->
            <div class="search-container" id="history-search-container" style="display: none;">
                <div class="search-input-wrapper">
                    <input type="text" id="history-search-input" placeholder="搜索聊天记录...">
                    <button id="cancel-search-btn">取消</button>
                </div>
            </div>
            
            <!-- 过滤选项 -->
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">全部</button>
                <button class="filter-tab" data-filter="today">今天</button>
                <button class="filter-tab" data-filter="week">本周</button>
                <button class="filter-tab" data-filter="month">本月</button>
            </div>
            
            <div class="list-container">
                <!-- 聊天历史列表 -->
                <div id="chat-history-list" class="chat-history-list">
                    <!-- 历史记录将在这里动态生成 -->
                    <div class="empty-history">
                        <p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                            暂无聊天历史记录
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 历史记录详情页面 -->
        <div id="history-detail-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="history-detail-back-btn">‹</span>
                <span id="history-detail-title">聊天详情</span>
                <div class="header-actions">
                    <span class="action-btn" id="export-history-btn">📤</span>
                    <span class="action-btn" id="delete-history-btn">🗑️</span>
                </div>
            </div>
            
            <div class="history-detail-container">
                <!-- 聊天信息 -->
                <div class="history-info">
                    <div class="history-avatar-container">
                        <img id="history-detail-avatar" class="history-avatar" alt="头像">
                    </div>
                    <div class="history-meta">
                        <h3 id="history-detail-name">聊天名称</h3>
                        <p id="history-detail-stats">消息数量: 0 | 时间跨度: -</p>
                    </div>
                </div>
                
                <!-- 消息列表 -->
                <div class="history-messages" id="history-messages-container">
                    <!-- 历史消息将在这里显示 -->
                </div>
            </div>
        </div>
        
        <!-- 聊天列表背景设置页面 -->
        <div id="chat-list-bg-screen" class="screen">
            <div class="header">
                <span class="back-btn">‹</span>
                <span>聊天背景</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="list-container">
                <p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                    聊天背景设置功能将在后续任务中实现
                </p>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================
        // 全局状态和数据管理
        // ===================================================================
        
        // 全局状态对象
        const state = {
            chats: {},              // 所有聊天数据
            activeChatId: null,     // 当前活跃聊天ID
            globalSettings: {       // 全局设置
                theme: 'default',
                fontSize: 14
            }
        };
        
        // 默认头像
        const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='45' height='45' viewBox='0 0 24 24' fill='%23007bff'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";
        const defaultGroupAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='45' height='45' viewBox='0 0 24 24' fill='%23ff6b6b'%3E%3Cpath d='M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zM4 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm8 0c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zM2 18v-3c0-1.1.9-2 2-2h3c1.1 0 2 .9 2 2v3H2zm7 0v-3c0-1.1.9-2 2-2h3c1.1 0 2 .9 2 2v3H9zm7 0v-3c0-1.1.9-2 2-2h3c1.1 0 2 .9 2 2v3h-7z'/%3E%3C/svg%3E";
        
        /**
         * 初始化示例聊天数据
         */
        function initializeSampleData() {
            state.chats = {
                'chat_1': {
                    id: 'chat_1',
                    name: '小助手',
                    isGroup: false,
                    avatar: defaultAvatar,
                    lastMessage: '你好！有什么可以帮助你的吗？',
                    timestamp: Date.now() - 3600000, // 1小时前
                    unreadCount: 0,
                    status: { text: '在线', lastUpdate: Date.now() },
                    history: [
                        {
                            role: 'ai',
                            content: '你好！我是你的智能助手，有什么可以帮助你的吗？',
                            timestamp: Date.now() - 3600000
                        },
                        {
                            role: 'user',
                            content: '你好！',
                            timestamp: Date.now() - 3500000
                        },
                        {
                            role: 'ai',
                            content: '很高兴见到你！我可以帮你解答问题、提供建议或者陪你聊天。你想聊什么呢？',
                            timestamp: Date.now() - 3400000
                        }
                    ]
                },
                'group_1': {
                    id: 'group_1',
                    name: '开发小组',
                    isGroup: true,
                    avatar: defaultGroupAvatar,
                    lastMessage: '张三: 今天的任务完成了吗？',
                    timestamp: Date.now() - 1800000, // 30分钟前
                    unreadCount: 3,
                    members: [
                        { name: '张三', avatar: defaultAvatar },
                        { name: '李四', avatar: defaultAvatar }
                    ],
                    history: [
                        {
                            role: 'system',
                            content: '群聊已创建',
                            timestamp: Date.now() - 7200000
                        },
                        {
                            role: 'user',
                            content: '大家好！',
                            senderName: '张三',
                            timestamp: Date.now() - 3600000
                        },
                        {
                            role: 'user',
                            content: '你好张三！',
                            senderName: '李四',
                            timestamp: Date.now() - 3500000
                        },
                        {
                            role: 'user',
                            content: '今天的任务完成了吗？',
                            senderName: '张三',
                            timestamp: Date.now() - 1800000
                        }
                    ]
                },
                'chat_2': {
                    id: 'chat_2',
                    name: '李四',
                    isGroup: false,
                    avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='45' height='45' viewBox='0 0 24 24' fill='%2352c41a'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E",
                    lastMessage: '[在线]',
                    timestamp: Date.now() - 7200000, // 2小时前
                    unreadCount: 0,
                    status: { text: '在线', lastUpdate: Date.now() },
                    history: []
                },
                'group_2': {
                    id: 'group_2',
                    name: '项目讨论组',
                    isGroup: true,
                    avatar: defaultGroupAvatar,
                    lastMessage: '王五: 明天的会议准备好了吗？',
                    timestamp: Date.now() - 5400000, // 1.5小时前
                    unreadCount: 1,
                    members: [
                        { name: '王五', avatar: defaultAvatar },
                        { name: '赵六', avatar: defaultAvatar }
                    ],
                    history: [
                        {
                            role: 'user',
                            content: '明天的会议准备好了吗？',
                            senderName: '王五',
                            timestamp: Date.now() - 5400000
                        }
                    ]
                },
                'chat_3': {
                    id: 'chat_3',
                    name: '客服小美',
                    isGroup: false,
                    avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='45' height='45' viewBox='0 0 24 24' fill='%23e91e63'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E",
                    lastMessage: '[忙碌]',
                    timestamp: Date.now() - 10800000, // 3小时前
                    unreadCount: 0,
                    status: { text: '忙碌', lastUpdate: Date.now() },
                    history: []
                }
            };
        }
        
        // ===================================================================
        // 聊天列表数据管理
        // ===================================================================
        
        /**
         * 创建聊天列表项HTML元素
         * @param {Object} chat - 聊天对象
         * @returns {HTMLElement} 聊天列表项元素
         */
        function createChatListItem(chat) {
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.dataset.chatId = chat.id;
            
            // 处理最后消息显示
            let lastMsgDisplay;
            if (chat.isGroup) {
                // 群聊显示实际消息内容
                lastMsgDisplay = chat.lastMessage || '暂无消息';
            } else {
                // 单聊显示在线状态
                lastMsgDisplay = `[${chat.status?.text || '在线'}]`;
            }
            
            // 未读消息数显示
            const unreadDisplay = chat.unreadCount > 0 ? 
                `<span class="unread-count">${chat.unreadCount}</span>` : 
                '<span class="unread-count" style="display: none;">0</span>';
            
            // 群聊标签
            const groupTag = chat.isGroup ? '<span class="group-tag">群聊</span>' : '';
            
            item.innerHTML = `
                <img src="${chat.avatar || defaultAvatar}" class="avatar" alt="${chat.name}头像">
                <div class="info">
                    <div class="name-line">
                        <span class="name">${chat.name}</span>
                        ${groupTag}
                    </div>
                    <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: ${chat.isGroup ? 'normal' : 'italic'};">${lastMsgDisplay}</div>
                </div>
                <div class="unread-count-wrapper">
                    ${unreadDisplay}
                </div>
            `;
            
            return item;
        }
        
        /**
         * 渲染聊天列表
         */
        function renderChatList() {
            const chatListEl = document.getElementById('chat-list');
            if (!chatListEl) return;
            
            // 获取当前过滤类型
            const filterType = getCurrentChatFilterType();
            
            // 获取所有聊天并按最新消息时间排序
            let allChats = Object.values(state.chats).sort((a, b) => 
                (b.timestamp || 0) - (a.timestamp || 0)
            );
            
            // 根据过滤类型筛选聊天
            const filteredChats = filterChatsByType(allChats, filterType);
            
            // 清空现有列表
            chatListEl.innerHTML = '';
            
            // 如果没有聊天，显示提示信息
            if (filteredChats.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.style.cssText = 'text-align: center; color: var(--text-secondary); margin-top: 50px; padding: 20px;';
                
                let messageText = '';
                switch(filterType) {
                    case 'single':
                        messageText = '暂无单聊';
                        break;
                    case 'group':
                        messageText = '暂无群聊';
                        break;
                    default:
                        messageText = '暂无聊天';
                }
                
                emptyMessage.textContent = messageText;
                chatListEl.appendChild(emptyMessage);
            } else {
                // 渲染聊天项
                filteredChats.forEach(chat => {
                    const item = createChatListItem(chat);
                    
                    // 绑定点击事件
                    const infoEl = item.querySelector('.info');
                    if (infoEl) {
                        infoEl.addEventListener('click', () => {
                            openChat(chat.id);
                        });
                    }
                    
                    chatListEl.appendChild(item);
                });
            }
            
            console.log(`聊天列表渲染完成，过滤类型: ${filterType}，显示 ${filteredChats.length} 个聊天`);
        }
        
        /**
         * 根据类型过滤聊天
         * @param {Array} chats - 聊天数组
         * @param {string} filterType - 过滤类型
         * @returns {Array} 过滤后的聊天数组
         */
        function filterChatsByType(chats, filterType) {
            switch(filterType) {
                case 'single':
                    return chats.filter(chat => !chat.isGroup);
                case 'group':
                    return chats.filter(chat => chat.isGroup);
                case 'all':
                default:
                    return chats;
            }
        }
        
        /**
         * 添加新聊天
         * @param {Object} chatData - 新聊天数据
         */
        function addChat(chatData) {
            const chatId = chatData.id || 'chat_' + Date.now();
            chatData.id = chatId;
            chatData.timestamp = chatData.timestamp || Date.now();
            
            state.chats[chatId] = chatData;
            renderChatList();
            
            console.log(`添加新聊天: ${chatData.name}`);
            return chatId;
        }
        
        /**
         * 删除聊天
         * @param {string} chatId - 聊天ID
         */
        function deleteChat(chatId) {
            if (state.chats[chatId]) {
                const chatName = state.chats[chatId].name;
                delete state.chats[chatId];
                
                if (state.activeChatId === chatId) {
                    state.activeChatId = null;
                }
                
                renderChatList();
                console.log(`删除聊天: ${chatName}`);
            }
        }
        
        /**
         * 更新聊天最后消息
         * @param {string} chatId - 聊天ID
         * @param {string} message - 消息内容
         * @param {string} senderName - 发送者名称（群聊用）
         */
        function updateChatLastMessage(chatId, message, senderName = null) {
            const chat = state.chats[chatId];
            if (chat) {
                if (chat.isGroup && senderName) {
                    chat.lastMessage = `${senderName}: ${message}`;
                } else {
                    chat.lastMessage = message;
                }
                chat.timestamp = Date.now();
                renderChatList();
            }
        }
        
        // ===================================================================
        // 页面导航系统
        // ===================================================================
        
        /**
         * 页面导航系统 - 增强版
         */
        const NavigationSystem = {
            // 页面历史记录栈
            history: [],
            
            // 当前页面
            currentScreen: null,
            
            // 页面切换动画配置
            animationConfig: {
                duration: 300,
                easing: 'ease-in-out'
            },
            
            // 页面状态缓存
            pageStates: {},
            
            /**
             * 显示指定页面，隐藏其他页面
             * @param {string} screenId - 要显示的页面ID
             * @param {Object} options - 切换选项
             */
            async showScreen(screenId, options = {}) {
                const {
                    animation = true,
                    addToHistory = true,
                    direction = 'forward',
                    data = null
                } = options;
                
                // 验证页面是否存在
                const targetScreen = document.getElementById(screenId);
                if (!targetScreen) {
                    console.error(`页面不存在: ${screenId}`);
                    return false;
                }
                
                // 保存当前页面状态
                if (this.currentScreen) {
                    this.savePageState(this.currentScreen);
                }
                
                // 添加到历史记录
                if (addToHistory && this.currentScreen !== screenId) {
                    this.addToHistory(screenId, data);
                }
                
                // 执行页面切换
                const success = await this.performScreenTransition(screenId, direction, animation);
                
                if (success) {
                    this.currentScreen = screenId;
                    
                    // 恢复页面状态
                    this.restorePageState(screenId);
                    
                    // 执行页面特殊处理
                    this.handleScreenSpecialLogic(screenId, data);
                    
                    // 更新导航状态
                    this.updateNavigationState(screenId);
                    
                    // 触发页面切换事件
                    this.triggerScreenChangeEvent(screenId, data);
                }
                
                return success;
            },
            
            /**
             * 执行页面切换动画
             */
            async performScreenTransition(screenId, direction, useAnimation) {
                const allScreens = document.querySelectorAll('.screen');
                const targetScreen = document.getElementById(screenId);
                const currentActiveScreen = document.querySelector('.screen.active');
                
                if (!useAnimation) {
                    // 无动画切换
                    allScreens.forEach(screen => screen.classList.remove('active'));
                    targetScreen.classList.add('active');
                    return true;
                }
                
                // 准备动画
                targetScreen.style.transform = direction === 'forward' ? 'translateX(100%)' : 'translateX(-100%)';
                targetScreen.classList.add('active');
                targetScreen.style.opacity = '0';
                
                // 强制重绘
                targetScreen.offsetHeight;
                
                // 执行动画
                return new Promise((resolve) => {
                    const animationDuration = this.animationConfig.duration;
                    
                    // 目标页面进入动画
                    targetScreen.style.transition = `transform ${animationDuration}ms ${this.animationConfig.easing}, opacity ${animationDuration}ms ${this.animationConfig.easing}`;
                    targetScreen.style.transform = 'translateX(0)';
                    targetScreen.style.opacity = '1';
                    
                    // 当前页面退出动画
                    if (currentActiveScreen && currentActiveScreen !== targetScreen) {
                        currentActiveScreen.style.transition = `transform ${animationDuration}ms ${this.animationConfig.easing}, opacity ${animationDuration}ms ${this.animationConfig.easing}`;
                        currentActiveScreen.style.transform = direction === 'forward' ? 'translateX(-100%)' : 'translateX(100%)';
                        currentActiveScreen.style.opacity = '0';
                    }
                    
                    // 动画完成后清理
                    setTimeout(() => {
                        allScreens.forEach(screen => {
                            if (screen !== targetScreen) {
                                screen.classList.remove('active');
                                screen.style.transform = '';
                                screen.style.opacity = '';
                                screen.style.transition = '';
                            }
                        });
                        
                        targetScreen.style.transform = '';
                        targetScreen.style.opacity = '';
                        targetScreen.style.transition = '';
                        
                        resolve(true);
                    }, animationDuration);
                });
            },
            
            /**
             * 添加到历史记录
             */
            addToHistory(screenId, data) {
                // 避免重复添加相同页面
                if (this.history.length > 0 && this.history[this.history.length - 1].screenId === screenId) {
                    return;
                }
                
                this.history.push({
                    screenId: screenId,
                    timestamp: Date.now(),
                    data: data
                });
                
                // 限制历史记录长度
                if (this.history.length > 50) {
                    this.history.shift();
                }
                
                // 持久化历史记录
                this.saveNavigationHistory();
            },
            
            /**
             * 返回上一页
             */
            async goBack() {
                if (this.history.length < 2) {
                    // 没有历史记录，返回主页
                    return await this.showScreen('chat-list-screen', { 
                        animation: true, 
                        direction: 'backward',
                        addToHistory: false 
                    });
                }
                
                // 移除当前页面
                this.history.pop();
                
                // 获取上一页
                const previousPage = this.history[this.history.length - 1];
                
                return await this.showScreen(previousPage.screenId, {
                    animation: true,
                    direction: 'backward',
                    addToHistory: false,
                    data: previousPage.data
                });
            },
            
            /**
             * 保存页面状态
             */
            savePageState(screenId) {
                const screen = document.getElementById(screenId);
                if (!screen) return;
                
                const state = {
                    scrollPosition: {},
                    formData: {},
                    customData: {}
                };
                
                // 保存滚动位置
                const scrollableElements = screen.querySelectorAll('[data-save-scroll]');
                scrollableElements.forEach(el => {
                    const id = el.id || el.dataset.saveScroll;
                    state.scrollPosition[id] = {
                        scrollTop: el.scrollTop,
                        scrollLeft: el.scrollLeft
                    };
                });
                
                // 保存表单数据
                const formElements = screen.querySelectorAll('input, textarea, select');
                formElements.forEach(el => {
                    if (el.id && el.dataset.saveState !== 'false') {
                        state.formData[el.id] = {
                            value: el.value,
                            checked: el.checked,
                            selectedIndex: el.selectedIndex
                        };
                    }
                });
                
                // 保存自定义状态
                if (screenId === 'chat-list-screen') {
                    state.customData.currentView = this.getCurrentChatListView();
                    state.customData.filterType = this.getCurrentFilterType();
                } else if (screenId === 'chat-interface-screen') {
                    state.customData.chatId = state.currentChatId;
                }
                
                this.pageStates[screenId] = state;
            },
            
            /**
             * 恢复页面状态
             */
            restorePageState(screenId) {
                const state = this.pageStates[screenId];
                if (!state) return;
                
                const screen = document.getElementById(screenId);
                if (!screen) return;
                
                // 恢复滚动位置
                Object.entries(state.scrollPosition).forEach(([id, position]) => {
                    const element = screen.querySelector(`#${id}`) || screen.querySelector(`[data-save-scroll="${id}"]`);
                    if (element) {
                        element.scrollTop = position.scrollTop;
                        element.scrollLeft = position.scrollLeft;
                    }
                });
                
                // 恢复表单数据
                Object.entries(state.formData).forEach(([id, data]) => {
                    const element = screen.querySelector(`#${id}`);
                    if (element) {
                        element.value = data.value;
                        if (typeof data.checked === 'boolean') {
                            element.checked = data.checked;
                        }
                        if (typeof data.selectedIndex === 'number') {
                            element.selectedIndex = data.selectedIndex;
                        }
                    }
                });
                
                // 恢复自定义状态
                if (screenId === 'chat-list-screen' && state.customData.currentView) {
                    setTimeout(() => {
                        switchToChatListView(state.customData.currentView);
                        if (state.customData.filterType) {
                            this.setFilterType(state.customData.filterType);
                        }
                    }, 50);
                }
            },
            
            /**
             * 处理页面特殊逻辑
             */
            handleScreenSpecialLogic(screenId, data) {
                switch (screenId) {
                    case 'chat-list-screen':
                        // 返回聊天列表时，默认显示消息视图
                        if (!this.pageStates[screenId]?.customData?.currentView) {
                            switchToChatListView('messages-view');
                        }
                        renderChatList();
                        break;
                        
                    case 'world-book-screen':
                        // 进入世界书页面时渲染列表
                        if (typeof renderWorldBookList === 'function') {
                            renderWorldBookList();
                        }
                        break;
                        
                    case 'chat-history-screen':
                        // 进入聊天历史页面时渲染列表
                        if (typeof renderChatHistoryList === 'function') {
                            renderChatHistoryList();
                        }
                        break;
                        
                    case 'chat-interface-screen':
                        // 进入聊天界面时的特殊处理
                        if (data && data.chatId) {
                            openChat(data.chatId);
                        }
                        break;
                        
                    case 'api-settings-screen':
                        // 进入API设置页面时加载设置
                        if (typeof initializeAPISettings === 'function') {
                            initializeAPISettings();
                        }
                        break;
                        
                    case 'wallpaper-screen':
                        // 进入外观设置页面时加载设置
                        if (typeof initializeAppearanceSettings === 'function') {
                            initializeAppearanceSettings();
                        }
                        break;
                        
                    case 'font-settings-screen':
                        // 进入字体设置页面时加载设置
                        if (typeof initializeFontSettings === 'function') {
                            initializeFontSettings();
                        }
                        break;
                }
            },
            
            /**
             * 更新导航状态
             */
            updateNavigationState(screenId) {
                // 更新底部导航栏状态
                const navItems = document.querySelectorAll('#chat-list-bottom-nav .nav-item');
                navItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                // 根据页面设置对应的导航项为活跃状态
                if (screenId === 'chat-list-screen') {
                    const currentView = this.getCurrentChatListView();
                    const activeNavItem = document.querySelector(`#chat-list-bottom-nav .nav-item[data-view="${currentView}"]`);
                    if (activeNavItem) {
                        activeNavItem.classList.add('active');
                    }
                }
            },
            
            /**
             * 触发页面切换事件
             */
            triggerScreenChangeEvent(screenId, data) {
                const event = new CustomEvent('screenChanged', {
                    detail: {
                        screenId: screenId,
                        data: data,
                        timestamp: Date.now()
                    }
                });
                document.dispatchEvent(event);
            },
            
            /**
             * 获取当前聊天列表视图
             */
            getCurrentChatListView() {
                const activeView = document.querySelector('.chat-list-view.active');
                return activeView ? activeView.id : 'messages-view';
            },
            
            /**
             * 获取当前过滤类型
             */
            getCurrentFilterType() {
                const activeToggle = document.querySelector('.toggle-btn.active');
                return activeToggle ? activeToggle.dataset.type : 'all';
            },
            
            /**
             * 设置过滤类型
             */
            setFilterType(filterType) {
                const toggleBtn = document.querySelector(`.toggle-btn[data-type="${filterType}"]`);
                if (toggleBtn) {
                    document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
                    toggleBtn.classList.add('active');
                }
            },
            
            /**
             * 保存导航历史到本地存储
             */
            saveNavigationHistory() {
                try {
                    const historyData = {
                        history: this.history.slice(-10), // 只保存最近10条
                        currentScreen: this.currentScreen,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('navigationHistory', JSON.stringify(historyData));
                } catch (error) {
                    console.error('保存导航历史失败:', error);
                }
            },
            
            /**
             * 从本地存储加载导航历史
             */
            loadNavigationHistory() {
                try {
                    const historyData = localStorage.getItem('navigationHistory');
                    if (historyData) {
                        const parsed = JSON.parse(historyData);
                        
                        // 检查数据是否过期（24小时）
                        if (Date.now() - parsed.timestamp < 24 * 60 * 60 * 1000) {
                            this.history = parsed.history || [];
                            this.currentScreen = parsed.currentScreen;
                        }
                    }
                } catch (error) {
                    console.error('加载导航历史失败:', error);
                }
            },
            
            /**
             * 清除导航历史
             */
            clearHistory() {
                this.history = [];
                this.pageStates = {};
                localStorage.removeItem('navigationHistory');
            },
            
            /**
             * 获取导航历史
             */
            getHistory() {
                return [...this.history];
            },
            
            /**
             * 初始化导航系统
             */
            init() {
                // 加载历史记录
                this.loadNavigationHistory();
                
                // 设置默认页面
                if (!this.currentScreen) {
                    this.currentScreen = 'chat-list-screen';
                }
                
                // 绑定返回按钮事件
                this.bindBackButtonEvents();
                
                // 监听浏览器返回事件
                this.bindBrowserBackEvent();
                
                console.log('导航系统初始化完成');
            },
            
            /**
             * 绑定返回按钮事件
             */
            bindBackButtonEvents() {
                const backButtons = document.querySelectorAll('.back-btn');
                backButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.goBack();
                    });
                });
            },
            
            /**
             * 绑定浏览器返回事件
             */
            bindBrowserBackEvent() {
                window.addEventListener('popstate', (e) => {
                    if (e.state && e.state.screenId) {
                        this.showScreen(e.state.screenId, { addToHistory: false });
                    } else {
                        this.goBack();
                    }
                });
            }
        };
        
        /**
         * 兼容性函数 - 保持向后兼容
         * @param {string} screenId - 要显示的页面ID
         */
        function showScreen(screenId) {
            return NavigationSystem.showScreen(screenId);
        }
        
        /**
         * 在聊天列表页面内切换不同视图
         * @param {string} viewId - 要显示的视图ID
         */
        function switchToChatListView(viewId) {
            const chatListScreen = document.getElementById('chat-list-screen');
            if (!chatListScreen) return;
            
            // 定义所有视图
            const views = {
                'messages-view': document.getElementById('messages-view'),
                'qzone-screen': document.getElementById('qzone-screen'),
                'favorites-view': document.getElementById('favorites-view'),
                'memories-view': document.getElementById('memories-view')
            };
            
            // 隐藏所有视图
            Object.values(views).forEach(view => {
                if (view) view.classList.remove('active');
            });
            
            // 显示目标视图
            if (views[viewId]) {
                views[viewId].classList.add('active');
            }
            
            // 更新底部导航栏高亮
            const navItems = document.querySelectorAll('#chat-list-bottom-nav .nav-item');
            navItems.forEach(item => {
                const isActive = item.dataset.view === viewId;
                item.classList.toggle('active', isActive);
            });
            
            // 根据视图类型执行特殊逻辑
            switch(viewId) {
                case 'qzone-screen':
                    console.log('切换到动态视图');
                    // renderQzoneScreen(); // 后续任务中实现
                    break;
                case 'favorites-view':
                    console.log('切换到收藏视图');
                    // renderFavoritesScreen(); // 后续任务中实现
                    break;
                case 'memories-view':
                    console.log('切换到回忆视图');
                    // renderMemoriesScreen(); // 后续任务中实现
                    break;
                case 'messages-view':
                default:
                    console.log('切换到消息视图');
                    break;
            }
        }
        
        /**
         * 获取当前活跃的页面ID
         * @returns {string|null} 当前活跃页面的ID
         */
        function getCurrentScreen() {
            const activeScreen = document.querySelector('.screen.active');
            return activeScreen ? activeScreen.id : null;
        }
        
        /**
         * 初始化页面导航系统
         */
        function initializeScreens() {
            // 确保聊天列表页面是默认激活的
            showScreen('chat-list-screen');
            
            // 绑定返回按钮事件（通用处理）
            const backButtons = document.querySelectorAll('.back-btn');
            backButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    showScreen('chat-list-screen');
                });
            });
            
            console.log('页面导航系统初始化完成');
        }
        
        // ===================================================================
        // 页面初始化
        // ===================================================================
        
        // ===================================================================
        // 聊天界面功能
        // ===================================================================
        
        /**
         * 打开指定聊天
         * @param {string} chatId - 聊天ID
         */
        function openChat(chatId) {
            const chat = state.chats[chatId];
            if (!chat) {
                console.error(`聊天不存在: ${chatId}`);
                return;
            }
            
            state.activeChatId = chatId;
            
            // 更新聊天界面头部信息
            updateChatInterfaceHeader(chat);
            
            // 渲染聊天消息
            renderChatMessages(chat);
            
            // 重置输入框
            resetChatInput();
            
            // 切换到聊天界面
            showScreen('chat-interface-screen');
            
            console.log(`打开聊天: ${chat.name} (${chatId})`);
        }
        
        /**
         * 重置聊天输入框
         */
        function resetChatInput() {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.value = '';
                autoResizeTextarea(chatInput);
                updateSendButtonState();
                chatInput.focus();
            }
        }
        
        /**
         * 更新聊天界面头部信息
         * @param {Object} chat - 聊天对象
         */
        function updateChatInterfaceHeader(chat) {
            const nameEl = document.getElementById('chat-interface-name');
            const statusEl = document.getElementById('chat-interface-status');
            
            if (nameEl) {
                nameEl.textContent = chat.name;
            }
            
            if (statusEl) {
                if (chat.isGroup) {
                    const memberCount = chat.members ? chat.members.length : 0;
                    statusEl.textContent = `${memberCount} 名成员`;
                } else {
                    statusEl.textContent = chat.status?.text || '在线';
                }
            }
        }
        
        /**
         * 渲染聊天消息
         * @param {Object} chat - 聊天对象
         */
        function renderChatMessages(chat) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            // 清空现有消息
            messagesContainer.innerHTML = '';
            
            // 如果没有消息历史，显示欢迎信息
            if (!chat.history || chat.history.length === 0) {
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = 'welcome-message';
                welcomeMessage.innerHTML = `
                    <p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                        ${chat.isGroup ? '群聊已创建，开始聊天吧！' : `开始与 ${chat.name} 聊天吧！`}
                    </p>
                `;
                messagesContainer.appendChild(welcomeMessage);
                return;
            }
            
            // 渲染消息历史
            chat.history.forEach(message => {
                const messageElement = createMessageElement(message, chat);
                messagesContainer.appendChild(messageElement);
            });
            
            // 滚动到底部
            scrollToBottom();
        }
        
        /**
         * 创建消息元素
         * @param {Object} message - 消息对象
         * @param {Object} chat - 聊天对象
         * @returns {HTMLElement} 消息元素
         */
        function createMessageElement(message, chat) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${message.role}`;
            wrapper.dataset.timestamp = message.timestamp;
            
            // 创建时间戳
            const timestamp = document.createElement('div');
            timestamp.className = 'message-timestamp';
            timestamp.textContent = formatTimestamp(message.timestamp);
            
            // 创建消息气泡
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            // 处理不同类型的消息
            if (message.type === 'system') {
                // 系统消息
                bubble.style.cssText = 'background-color: #f0f0f0; color: #666; text-align: center; font-style: italic;';
                bubble.textContent = message.content;
            } else if (message.type === 'user_photo' || message.type === 'ai_image') {
                // 图片消息
                bubble.innerHTML = `<div style="font-style: italic; color: #666;">📷 ${message.content}</div>`;
            } else if (message.type === 'file') {
                // 文件消息
                bubble.innerHTML = `<div style="font-style: italic; color: #666;">📎 ${message.content}</div>`;
            } else if (message.type === 'voice_message') {
                // 语音消息
                bubble.innerHTML = `<div style="font-style: italic; color: #666;">🎤 ${message.content}</div>`;
            } else {
                // 普通文本消息
                bubble.textContent = message.content;
                
                // 群聊中显示发送者名称
                if (chat.isGroup && message.role === 'user' && message.senderName) {
                    const senderName = document.createElement('div');
                    senderName.style.cssText = 'font-size: 11px; color: #666; margin-bottom: 3px; font-weight: 500;';
                    senderName.textContent = message.senderName;
                    bubble.insertBefore(senderName, bubble.firstChild);
                }
            }
            
            // 组装消息元素
            if (message.role === 'user') {
                wrapper.appendChild(timestamp);
                wrapper.appendChild(bubble);
            } else {
                wrapper.appendChild(bubble);
                wrapper.appendChild(timestamp);
            }
            
            return wrapper;
        }
        
        /**
         * 添加新消息到聊天界面
         * @param {Object} message - 消息对象
         * @param {Object} chat - 聊天对象
         */
        function appendMessage(message, chat) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            // 移除欢迎消息
            const welcomeMessage = messagesContainer.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            // 创建并添加新消息
            const messageElement = createMessageElement(message, chat);
            messagesContainer.appendChild(messageElement);
            
            // 滚动到底部
            scrollToBottom();
        }
        
        /**
         * 滚动消息列表到底部
         */
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        /**
         * 格式化时间戳
         * @param {number} timestamp - 时间戳
         * @returns {string} 格式化后的时间
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;
            
            if (messageDate.getTime() === today.getTime()) {
                // 今天的消息只显示时间
                return timeStr;
            } else {
                // 其他日期显示日期和时间
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${month}-${day} ${timeStr}`;
            }
        }
        
        // ===================================================================
        // API设置页面功能
        // ===================================================================
        
        /**
         * 初始化API设置
         */
        function initializeAPISettings() {
            // 默认API设置
            const defaultSettings = {
                provider: 'openai',
                apiKey: '',
                model: 'gpt-3.5-turbo',
                baseUrl: 'https://api.openai.com/v1',
                maxTokens: 2000,
                temperature: 0.7,
                streamResponse: true,
                enableVision: false
            };
            
            // 从localStorage加载设置或使用默认设置
            const savedSettings = localStorage.getItem('apiSettings');
            const apiSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            
            // 更新全局状态
            state.globalSettings.apiSettings = apiSettings;
            
            // 加载设置到表单
            loadAPISettingsToForm(apiSettings);
        }
        
        /**
         * 加载API设置到表单
         * @param {Object} settings - API设置对象
         */
        function loadAPISettingsToForm(settings) {
            const elements = {
                provider: document.getElementById('api-provider'),
                apiKey: document.getElementById('api-key'),
                model: document.getElementById('api-model'),
                baseUrl: document.getElementById('api-base-url'),
                maxTokens: document.getElementById('max-tokens'),
                temperature: document.getElementById('temperature'),
                streamResponse: document.getElementById('stream-response'),
                enableVision: document.getElementById('enable-vision')
            };
            
            // 设置表单值
            if (elements.provider) elements.provider.value = settings.provider || 'openai';
            if (elements.apiKey) elements.apiKey.value = settings.apiKey || '';
            if (elements.model) elements.model.value = settings.model || 'gpt-3.5-turbo';
            if (elements.baseUrl) elements.baseUrl.value = settings.baseUrl || 'https://api.openai.com/v1';
            if (elements.maxTokens) elements.maxTokens.value = settings.maxTokens || 2000;
            if (elements.temperature) {
                elements.temperature.value = settings.temperature || 0.7;
                updateTemperatureDisplay(settings.temperature || 0.7);
            }
            if (elements.streamResponse) elements.streamResponse.checked = settings.streamResponse !== false;
            if (elements.enableVision) elements.enableVision.checked = settings.enableVision === true;
        }
        
        /**
         * 从表单获取API设置
         * @returns {Object} API设置对象
         */
        function getAPISettingsFromForm() {
            const elements = {
                provider: document.getElementById('api-provider'),
                apiKey: document.getElementById('api-key'),
                model: document.getElementById('api-model'),
                baseUrl: document.getElementById('api-base-url'),
                maxTokens: document.getElementById('max-tokens'),
                temperature: document.getElementById('temperature'),
                streamResponse: document.getElementById('stream-response'),
                enableVision: document.getElementById('enable-vision')
            };
            
            return {
                provider: elements.provider?.value || 'openai',
                apiKey: elements.apiKey?.value || '',
                model: elements.model?.value || 'gpt-3.5-turbo',
                baseUrl: elements.baseUrl?.value || 'https://api.openai.com/v1',
                maxTokens: parseInt(elements.maxTokens?.value) || 2000,
                temperature: parseFloat(elements.temperature?.value) || 0.7,
                streamResponse: elements.streamResponse?.checked !== false,
                enableVision: elements.enableVision?.checked === true
            };
        }
        
        /**
         * 保存API设置
         */
        function saveAPISettings() {
            const settings = getAPISettingsFromForm();
            
            // 验证必填字段
            if (!settings.apiKey.trim()) {
                showAPIStatus('请输入API密钥', 'error');
                return;
            }
            
            // 保存到localStorage
            DataStorage.save(DataStorage.KEYS.API_SETTINGS, settings);
            
            // 更新全局状态
            state.globalSettings.apiSettings = settings;
            
            showAPIStatus('设置保存成功！', 'success');
            console.log('API设置已保存:', settings);
        }
        
        /**
         * 测试API连接
         */
        async function testAPIConnection() {
            const settings = getAPISettingsFromForm();
            
            if (!settings.apiKey.trim()) {
                showAPIStatus('请先输入API密钥', 'error');
                return;
            }
            
            showAPIStatus('正在测试连接...', 'loading');
            
            try {
                // 模拟API测试（实际应用中这里会发送真实的API请求）
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 随机成功或失败（用于演示）
                const isSuccess = Math.random() > 0.3;
                
                if (isSuccess) {
                    showAPIStatus('连接测试成功！API配置正常', 'success');
                } else {
                    showAPIStatus('连接测试失败，请检查API密钥和配置', 'error');
                }
            } catch (error) {
                showAPIStatus('连接测试失败：' + error.message, 'error');
            }
        }
        
        /**
         * 重置API设置为默认值
         */
        function resetAPISettings() {
            const defaultSettings = {
                provider: 'openai',
                apiKey: '',
                model: 'gpt-3.5-turbo',
                baseUrl: 'https://api.openai.com/v1',
                maxTokens: 2000,
                temperature: 0.7,
                streamResponse: true,
                enableVision: false
            };
            
            loadAPISettingsToForm(defaultSettings);
            showAPIStatus('设置已重置为默认值', 'success');
        }
        
        /**
         * 显示API状态信息
         * @param {string} message - 状态消息
         * @param {string} type - 状态类型 ('success', 'error', 'loading')
         */
        function showAPIStatus(message, type) {
            const statusEl = document.getElementById('api-status');
            const statusTextEl = document.getElementById('api-status-text');
            
            if (statusEl && statusTextEl) {
                statusTextEl.textContent = message;
                statusEl.className = `api-status ${type}`;
                statusEl.style.display = 'block';
                
                // 3秒后自动隐藏（除了错误信息）
                if (type !== 'error') {
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                }
            }
        }
        
        /**
         * 更新温度显示
         * @param {number} value - 温度值
         */
        function updateTemperatureDisplay(value) {
            const displayEl = document.getElementById('temperature-value');
            if (displayEl) {
                displayEl.textContent = value;
            }
        }
        
        /**
         * 绑定API设置页面事件
         */
        function bindAPISettingsEvents() {
            // 保存设置按钮
            const saveBtn = document.getElementById('save-api-settings-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveAPISettings);
            }
            
            // 测试连接按钮
            const testBtn = document.getElementById('test-api-btn');
            if (testBtn) {
                testBtn.addEventListener('click', testAPIConnection);
            }
            
            // 重置设置按钮
            const resetBtn = document.getElementById('reset-api-settings-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetAPISettings);
            }
            
            // 温度滑块
            const temperatureSlider = document.getElementById('temperature');
            if (temperatureSlider) {
                temperatureSlider.addEventListener('input', (e) => {
                    updateTemperatureDisplay(e.target.value);
                });
            }
            
            // API提供商变化时更新模型选项
            const providerSelect = document.getElementById('api-provider');
            if (providerSelect) {
                providerSelect.addEventListener('change', updateModelOptions);
            }
        }
        
        /**
         * 根据API提供商更新模型选项
         */
        function updateModelOptions() {
            const provider = document.getElementById('api-provider')?.value;
            const modelSelect = document.getElementById('api-model');
            
            if (!modelSelect) return;
            
            // 清空现有选项
            modelSelect.innerHTML = '';
            
            // 根据提供商添加相应的模型选项
            const modelOptions = {
                openai: [
                    { value: 'gpt-4', text: 'GPT-4' },
                    { value: 'gpt-4-turbo', text: 'GPT-4 Turbo' },
                    { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo' }
                ],
                anthropic: [
                    { value: 'claude-3-opus', text: 'Claude 3 Opus' },
                    { value: 'claude-3-sonnet', text: 'Claude 3 Sonnet' },
                    { value: 'claude-3-haiku', text: 'Claude 3 Haiku' }
                ],
                google: [
                    { value: 'gemini-pro', text: 'Gemini Pro' },
                    { value: 'gemini-pro-vision', text: 'Gemini Pro Vision' }
                ],
                local: [
                    { value: 'llama-2', text: 'Llama 2' },
                    { value: 'mistral', text: 'Mistral' },
                    { value: 'custom', text: '自定义模型' }
                ]
            };
            
            const options = modelOptions[provider] || modelOptions.openai;
            options.forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option.value;
                optionEl.textContent = option.text;
                modelSelect.appendChild(optionEl);
            });
        }
        
        // ===================================================================
        // 外观设置页面功能
        // ===================================================================
        
        /**
         * 初始化外观设置
         */
        function initializeAppearanceSettings() {
            // 默认外观设置
            const defaultSettings = {
                theme: 'light',
                wallpaper: '',
                wallpaperOpacity: 80,
                bubbleStyle: 'normal',
                fontSize: 14,
                compactMode: false,
                enableAnimations: true
            };
            
            // 从localStorage加载设置或使用默认设置
            const savedSettings = localStorage.getItem('appearanceSettings');
            const appearanceSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            
            // 更新全局状态
            state.globalSettings.appearanceSettings = appearanceSettings;
            
            // 加载设置到表单
            loadAppearanceSettingsToForm(appearanceSettings);
            
            // 应用设置到界面
            applyAppearanceSettings(appearanceSettings);
        }
        
        /**
         * 加载外观设置到表单
         * @param {Object} settings - 外观设置对象
         */
        function loadAppearanceSettingsToForm(settings) {
            // 主题设置
            const themeRadio = document.querySelector(`input[name="theme"][value="${settings.theme}"]`);
            if (themeRadio) themeRadio.checked = true;
            
            // 背景壁纸
            const wallpaperPreview = document.getElementById('wallpaper-preview');
            if (wallpaperPreview && settings.wallpaper) {
                wallpaperPreview.style.backgroundImage = `url(${settings.wallpaper})`;
                wallpaperPreview.innerHTML = '';
            }
            
            // 背景透明度
            const opacitySlider = document.getElementById('wallpaper-opacity');
            if (opacitySlider) {
                opacitySlider.value = settings.wallpaperOpacity || 80;
                updateWallpaperOpacityDisplay(settings.wallpaperOpacity || 80);
            }
            
            // 气泡样式
            document.querySelectorAll('.bubble-option').forEach(option => {
                option.classList.toggle('active', option.dataset.style === settings.bubbleStyle);
            });
            
            // 字体大小
            const fontSizeSlider = document.getElementById('font-size');
            if (fontSizeSlider) {
                fontSizeSlider.value = settings.fontSize || 14;
                updateFontSizeDisplay(settings.fontSize || 14);
            }
            
            // 紧凑模式
            const compactModeCheckbox = document.getElementById('compact-mode');
            if (compactModeCheckbox) compactModeCheckbox.checked = settings.compactMode === true;
            
            // 动画效果
            const animationsCheckbox = document.getElementById('enable-animations');
            if (animationsCheckbox) animationsCheckbox.checked = settings.enableAnimations !== false;
        }
        
        /**
         * 从表单获取外观设置
         * @returns {Object} 外观设置对象
         */
        function getAppearanceSettingsFromForm() {
            const themeRadio = document.querySelector('input[name="theme"]:checked');
            const wallpaperPreview = document.getElementById('wallpaper-preview');
            const opacitySlider = document.getElementById('wallpaper-opacity');
            const activeBubbleOption = document.querySelector('.bubble-option.active');
            const fontSizeSlider = document.getElementById('font-size');
            const compactModeCheckbox = document.getElementById('compact-mode');
            const animationsCheckbox = document.getElementById('enable-animations');
            
            return {
                theme: themeRadio?.value || 'light',
                wallpaper: wallpaperPreview?.style.backgroundImage ? 
                    wallpaperPreview.style.backgroundImage.slice(5, -2) : '',
                wallpaperOpacity: parseInt(opacitySlider?.value) || 80,
                bubbleStyle: activeBubbleOption?.dataset.style || 'normal',
                fontSize: parseInt(fontSizeSlider?.value) || 14,
                compactMode: compactModeCheckbox?.checked === true,
                enableAnimations: animationsCheckbox?.checked !== false
            };
        }
        
        /**
         * 应用外观设置到界面
         * @param {Object} settings - 外观设置对象
         */
        function applyAppearanceSettings(settings) {
            const phoneScreen = document.getElementById('phone-screen');
            if (!phoneScreen) return;
            
            // 应用主题
            phoneScreen.className = phoneScreen.className.replace(/theme-\w+/g, '');
            phoneScreen.classList.add(`theme-${settings.theme}`);
            
            // 应用字体大小
            document.documentElement.style.setProperty('--base-font-size', `${settings.fontSize}px`);
            
            // 应用紧凑模式
            if (settings.compactMode) {
                phoneScreen.classList.add('compact-mode');
            } else {
                phoneScreen.classList.remove('compact-mode');
            }
            
            // 应用动画设置
            if (!settings.enableAnimations) {
                phoneScreen.classList.add('no-animations');
            } else {
                phoneScreen.classList.remove('no-animations');
            }
            
            // 应用背景壁纸
            if (settings.wallpaper) {
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    chatMessages.style.backgroundImage = `url(${settings.wallpaper})`;
                    chatMessages.style.backgroundSize = 'cover';
                    chatMessages.style.backgroundPosition = 'center';
                    chatMessages.style.backgroundAttachment = 'fixed';
                }
            }
        }
        
        /**
         * 保存外观设置
         */
        function saveAppearanceSettings() {
            const settings = getAppearanceSettingsFromForm();
            
            // 保存到localStorage
            DataStorage.save(DataStorage.KEYS.APPEARANCE_SETTINGS, settings);
            
            // 更新全局状态
            state.globalSettings.appearanceSettings = settings;
            
            // 应用设置到界面
            applyAppearanceSettings(settings);
            
            showAppearanceStatus('外观设置保存成功！', 'success');
            console.log('外观设置已保存:', settings);
        }
        
        /**
         * 重置外观设置为默认值
         */
        function resetAppearanceSettings() {
            const defaultSettings = {
                theme: 'light',
                wallpaper: '',
                wallpaperOpacity: 80,
                bubbleStyle: 'normal',
                fontSize: 14,
                compactMode: false,
                enableAnimations: true
            };
            
            loadAppearanceSettingsToForm(defaultSettings);
            applyAppearanceSettings(defaultSettings);
            showAppearanceStatus('外观设置已重置为默认值', 'success');
        }
        
        /**
         * 处理壁纸上传
         */
        function handleWallpaperUpload() {
            const fileInput = document.getElementById('wallpaper-upload');
            const preview = document.getElementById('wallpaper-preview');
            
            if (!fileInput || !preview) return;
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        preview.style.backgroundImage = `url(${imageUrl})`;
                        preview.innerHTML = '';
                        showAppearanceStatus('背景图片已选择', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        /**
         * 移除背景壁纸
         */
        function removeWallpaper() {
            const preview = document.getElementById('wallpaper-preview');
            if (preview) {
                preview.style.backgroundImage = '';
                preview.innerHTML = '<span>点击选择背景图片</span>';
                showAppearanceStatus('背景图片已移除', 'success');
            }
        }
        
        /**
         * 更新壁纸透明度显示
         * @param {number} value - 透明度值
         */
        function updateWallpaperOpacityDisplay(value) {
            const displayEl = document.getElementById('wallpaper-opacity-value');
            if (displayEl) {
                displayEl.textContent = `${value}%`;
            }
        }
        
        /**
         * 更新字体大小显示
         * @param {number} value - 字体大小值
         */
        function updateFontSizeDisplay(value) {
            const displayEl = document.getElementById('font-size-value');
            if (displayEl) {
                displayEl.textContent = `${value}px`;
            }
        }
        
        /**
         * 显示外观设置状态信息
         * @param {string} message - 状态消息
         * @param {string} type - 状态类型 ('success', 'error')
         */
        function showAppearanceStatus(message, type) {
            const statusEl = document.getElementById('appearance-status');
            const statusTextEl = document.getElementById('appearance-status-text');
            
            if (statusEl && statusTextEl) {
                statusTextEl.textContent = message;
                statusEl.className = `appearance-status ${type}`;
                statusEl.style.display = 'block';
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }
        
        /**
         * 绑定外观设置页面事件
         */
        function bindAppearanceSettingsEvents() {
            // 保存设置按钮
            const saveBtn = document.getElementById('save-appearance-settings-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveAppearanceSettings);
            }
            
            // 重置设置按钮
            const resetBtn = document.getElementById('reset-appearance-settings-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetAppearanceSettings);
            }
            
            // 选择壁纸按钮
            const selectWallpaperBtn = document.getElementById('select-wallpaper-btn');
            const wallpaperUpload = document.getElementById('wallpaper-upload');
            if (selectWallpaperBtn && wallpaperUpload) {
                selectWallpaperBtn.addEventListener('click', () => {
                    wallpaperUpload.click();
                });
            }
            
            // 移除壁纸按钮
            const removeWallpaperBtn = document.getElementById('remove-wallpaper-btn');
            if (removeWallpaperBtn) {
                removeWallpaperBtn.addEventListener('click', removeWallpaper);
            }
            
            // 壁纸预览点击
            const wallpaperPreview = document.getElementById('wallpaper-preview');
            if (wallpaperPreview && wallpaperUpload) {
                wallpaperPreview.addEventListener('click', () => {
                    wallpaperUpload.click();
                });
            }
            
            // 透明度滑块
            const opacitySlider = document.getElementById('wallpaper-opacity');
            if (opacitySlider) {
                opacitySlider.addEventListener('input', (e) => {
                    updateWallpaperOpacityDisplay(e.target.value);
                });
            }
            
            // 字体大小滑块
            const fontSizeSlider = document.getElementById('font-size');
            if (fontSizeSlider) {
                fontSizeSlider.addEventListener('input', (e) => {
                    updateFontSizeDisplay(e.target.value);
                });
            }
            
            // 气泡样式选择
            document.querySelectorAll('.bubble-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.bubble-option').forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                });
            });
            
            // 处理壁纸上传
            handleWallpaperUpload();
        }
        
        // ===================================================================
        // 字体设置页面功能
        // ===================================================================
        
        /**
         * 初始化字体设置
         */
        function initializeFontSettings() {
            // 默认字体设置
            const defaultSettings = {
                fontFamily: 'system',
                customFontUrl: '',
                fontSize: 14,
                lineHeight: 1.4,
                fontWeight: '400',
                letterSpacing: 0,
                messageFontSize: 14,
                uiFontSize: 13,
                fontSmoothing: true
            };
            
            // 从localStorage加载设置或使用默认设置
            const savedSettings = localStorage.getItem('fontSettings');
            const fontSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            
            // 更新全局状态
            state.globalSettings.fontSettings = fontSettings;
            
            // 加载设置到表单
            loadFontSettingsToForm(fontSettings);
            
            // 应用设置到界面
            applyFontSettings(fontSettings);
        }
        
        /**
         * 加载字体设置到表单
         * @param {Object} settings - 字体设置对象
         */
        function loadFontSettingsToForm(settings) {
            const elements = {
                fontFamily: document.getElementById('font-family'),
                customFontUrl: document.getElementById('custom-font-url'),
                fontSize: document.getElementById('font-size-setting'),
                lineHeight: document.getElementById('line-height'),
                fontWeight: document.getElementById('font-weight'),
                letterSpacing: document.getElementById('letter-spacing'),
                messageFontSize: document.getElementById('message-font-size'),
                uiFontSize: document.getElementById('ui-font-size'),
                fontSmoothing: document.getElementById('font-smoothing')
            };
            
            // 设置表单值
            if (elements.fontFamily) elements.fontFamily.value = settings.fontFamily || 'system';
            if (elements.customFontUrl) elements.customFontUrl.value = settings.customFontUrl || '';
            if (elements.fontSize) {
                elements.fontSize.value = settings.fontSize || 14;
                updateFontSizeSettingDisplay(settings.fontSize || 14);
            }
            if (elements.lineHeight) {
                elements.lineHeight.value = settings.lineHeight || 1.4;
                updateLineHeightDisplay(settings.lineHeight || 1.4);
            }
            if (elements.fontWeight) elements.fontWeight.value = settings.fontWeight || '400';
            if (elements.letterSpacing) {
                elements.letterSpacing.value = settings.letterSpacing || 0;
                updateLetterSpacingDisplay(settings.letterSpacing || 0);
            }
            if (elements.messageFontSize) {
                elements.messageFontSize.value = settings.messageFontSize || 14;
                updateMessageFontSizeDisplay(settings.messageFontSize || 14);
            }
            if (elements.uiFontSize) {
                elements.uiFontSize.value = settings.uiFontSize || 13;
                updateUIFontSizeDisplay(settings.uiFontSize || 13);
            }
            if (elements.fontSmoothing) elements.fontSmoothing.checked = settings.fontSmoothing !== false;
        }
        
        /**
         * 从表单获取字体设置
         * @returns {Object} 字体设置对象
         */
        function getFontSettingsFromForm() {
            const elements = {
                fontFamily: document.getElementById('font-family'),
                customFontUrl: document.getElementById('custom-font-url'),
                fontSize: document.getElementById('font-size-setting'),
                lineHeight: document.getElementById('line-height'),
                fontWeight: document.getElementById('font-weight'),
                letterSpacing: document.getElementById('letter-spacing'),
                messageFontSize: document.getElementById('message-font-size'),
                uiFontSize: document.getElementById('ui-font-size'),
                fontSmoothing: document.getElementById('font-smoothing')
            };
            
            return {
                fontFamily: elements.fontFamily?.value || 'system',
                customFontUrl: elements.customFontUrl?.value || '',
                fontSize: parseInt(elements.fontSize?.value) || 14,
                lineHeight: parseFloat(elements.lineHeight?.value) || 1.4,
                fontWeight: elements.fontWeight?.value || '400',
                letterSpacing: parseFloat(elements.letterSpacing?.value) || 0,
                messageFontSize: parseInt(elements.messageFontSize?.value) || 14,
                uiFontSize: parseInt(elements.uiFontSize?.value) || 13,
                fontSmoothing: elements.fontSmoothing?.checked !== false
            };
        }
        
        /**
         * 应用字体设置到界面
         * @param {Object} settings - 字体设置对象
         */
        function applyFontSettings(settings) {
            const root = document.documentElement;
            
            // 应用字体族
            let fontFamily = '';
            switch (settings.fontFamily) {
                case 'serif':
                    fontFamily = 'Georgia, "Times New Roman", Times, serif';
                    break;
                case 'sans-serif':
                    fontFamily = 'Arial, Helvetica, sans-serif';
                    break;
                case 'monospace':
                    fontFamily = '"Courier New", Courier, monospace';
                    break;
                case 'cursive':
                    fontFamily = '"Comic Sans MS", cursive';
                    break;
                case 'fantasy':
                    fontFamily = 'Impact, fantasy';
                    break;
                default:
                    fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
            }
            
            // 如果有自定义字体URL，加载它
            if (settings.customFontUrl) {
                loadCustomFont(settings.customFontUrl);
                fontFamily = 'CustomFont, ' + fontFamily;
            }
            
            // 应用CSS变量
            root.style.setProperty('--font-family', fontFamily);
            root.style.setProperty('--font-size', `${settings.fontSize}px`);
            root.style.setProperty('--line-height', settings.lineHeight);
            root.style.setProperty('--font-weight', settings.fontWeight);
            root.style.setProperty('--letter-spacing', `${settings.letterSpacing}em`);
            root.style.setProperty('--message-font-size', `${settings.messageFontSize}px`);
            root.style.setProperty('--ui-font-size', `${settings.uiFontSize}px`);
            
            // 应用字体平滑
            const body = document.body;
            if (settings.fontSmoothing) {
                body.classList.add('font-smoothing');
            } else {
                body.classList.remove('font-smoothing');
            }
            
            // 更新预览
            updateFontPreview(settings);
        }
        
        /**
         * 加载自定义字体
         * @param {string} fontUrl - 字体URL
         */
        function loadCustomFont(fontUrl) {
            // 移除之前的自定义字体
            const existingLink = document.getElementById('custom-font-link');
            if (existingLink) {
                existingLink.remove();
            }
            
            // 添加新的字体链接
            const link = document.createElement('link');
            link.id = 'custom-font-link';
            link.rel = 'stylesheet';
            link.href = fontUrl;
            document.head.appendChild(link);
        }
        
        /**
         * 更新字体预览
         * @param {Object} settings - 字体设置对象
         */
        function updateFontPreview(settings) {
            const preview = document.getElementById('font-preview');
            if (preview) {
                preview.style.fontFamily = `var(--font-family)`;
                preview.style.fontSize = `${settings.fontSize}px`;
                preview.style.lineHeight = settings.lineHeight;
                preview.style.fontWeight = settings.fontWeight;
                preview.style.letterSpacing = `${settings.letterSpacing}em`;
                
                // 更新消息预览的字体大小
                const messages = preview.querySelectorAll('.preview-message');
                messages.forEach(msg => {
                    msg.style.fontSize = `${settings.messageFontSize}px`;
                });
            }
        }
        
        /**
         * 保存字体设置
         */
        function saveFontSettings() {
            const settings = getFontSettingsFromForm();
            
            // 保存到localStorage
            DataStorage.save(DataStorage.KEYS.FONT_SETTINGS, settings);
            
            // 更新全局状态
            state.globalSettings.fontSettings = settings;
            
            // 应用设置到界面
            applyFontSettings(settings);
            
            showFontStatus('字体设置保存成功！', 'success');
            console.log('字体设置已保存:', settings);
        }
        
        /**
         * 重置字体设置为默认值
         */
        function resetFontSettings() {
            const defaultSettings = {
                fontFamily: 'system',
                customFontUrl: '',
                fontSize: 14,
                lineHeight: 1.4,
                fontWeight: '400',
                letterSpacing: 0,
                messageFontSize: 14,
                uiFontSize: 13,
                fontSmoothing: true
            };
            
            loadFontSettingsToForm(defaultSettings);
            applyFontSettings(defaultSettings);
            showFontStatus('字体设置已重置为默认值', 'success');
        }
        
        /**
         * 显示字体设置状态信息
         * @param {string} message - 状态消息
         * @param {string} type - 状态类型 ('success', 'error')
         */
        function showFontStatus(message, type) {
            const statusEl = document.getElementById('font-status');
            const statusTextEl = document.getElementById('font-status-text');
            
            if (statusEl && statusTextEl) {
                statusTextEl.textContent = message;
                statusEl.className = `font-status ${type}`;
                statusEl.style.display = 'block';
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }
        
        // 显示值更新函数
        function updateFontSizeSettingDisplay(value) {
            const displayEl = document.getElementById('font-size-setting-value');
            if (displayEl) displayEl.textContent = `${value}px`;
        }
        
        function updateLineHeightDisplay(value) {
            const displayEl = document.getElementById('line-height-value');
            if (displayEl) displayEl.textContent = value;
        }
        
        function updateLetterSpacingDisplay(value) {
            const displayEl = document.getElementById('letter-spacing-value');
            if (displayEl) displayEl.textContent = `${value}em`;
        }
        
        function updateMessageFontSizeDisplay(value) {
            const displayEl = document.getElementById('message-font-size-value');
            if (displayEl) displayEl.textContent = `${value}px`;
        }
        
        function updateUIFontSizeDisplay(value) {
            const displayEl = document.getElementById('ui-font-size-value');
            if (displayEl) displayEl.textContent = `${value}px`;
        }
        
        /**
         * 绑定字体设置页面事件
         */
        function bindFontSettingsEvents() {
            // 保存设置按钮
            const saveBtn = document.getElementById('save-font-settings-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveFontSettings);
            }
            
            // 重置设置按钮
            const resetBtn = document.getElementById('reset-font-settings-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetFontSettings);
            }
            
            // 滑块事件
            const sliders = [
                { id: 'font-size-setting', updateFn: updateFontSizeSettingDisplay },
                { id: 'line-height', updateFn: updateLineHeightDisplay },
                { id: 'letter-spacing', updateFn: updateLetterSpacingDisplay },
                { id: 'message-font-size', updateFn: updateMessageFontSizeDisplay },
                { id: 'ui-font-size', updateFn: updateUIFontSizeDisplay }
            ];
            
            sliders.forEach(slider => {
                const element = document.getElementById(slider.id);
                if (element) {
                    element.addEventListener('input', (e) => {
                        slider.updateFn(e.target.value);
                        // 实时预览
                        const settings = getFontSettingsFromForm();
                        updateFontPreview(settings);
                    });
                }
            });
            
            // 字体族和字重变化时实时预览
            const selects = ['font-family', 'font-weight'];
            selects.forEach(selectId => {
                const element = document.getElementById(selectId);
                if (element) {
                    element.addEventListener('change', () => {
                        const settings = getFontSettingsFromForm();
                        updateFontPreview(settings);
                    });
                }
            });
            
            // 自定义字体URL变化时实时预览
            const customFontUrl = document.getElementById('custom-font-url');
            if (customFontUrl) {
                customFontUrl.addEventListener('input', () => {
                    const settings = getFontSettingsFromForm();
                    updateFontPreview(settings);
                });
            }
        }
        
        // ===================================================================
        // 动态页面功能
        // ===================================================================
        
        /**
         * 初始化动态页面数据
         */
        function initializeQzoneData() {
            // 默认用户信息
            const defaultUserInfo = {
                name: '我的昵称',
                status: '今天心情不错 😊',
                avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 24 24' fill='%23007bff'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"
            };
            
            // 从localStorage加载或使用默认值
            const savedUserInfo = localStorage.getItem('qzoneUserInfo');
            const userInfo = savedUserInfo ? JSON.parse(savedUserInfo) : defaultUserInfo;
            
            // 初始化动态数据
            const savedPosts = localStorage.getItem('qzonePosts');
            const posts = savedPosts ? JSON.parse(savedPosts) : [];
            
            // 更新全局状态
            state.qzoneData = {
                userInfo: userInfo,
                posts: posts,
                stats: {
                    postsCount: posts.length,
                    friendsCount: Object.values(state.chats).filter(chat => !chat.isGroup).length,
                    visitsCount: Math.floor(Math.random() * 100) + 50 // 模拟访问数
                }
            };
        }
        
        /**
         * 渲染动态页面
         */
        function renderQzoneScreen() {
            if (!state.qzoneData) {
                initializeQzoneData();
            }
            
            const { userInfo, stats } = state.qzoneData;
            
            // 更新用户信息
            const userNameEl = document.getElementById('qzone-user-name');
            const userStatusEl = document.getElementById('qzone-user-status');
            const userAvatarEl = document.getElementById('qzone-user-avatar');
            
            if (userNameEl) userNameEl.textContent = userInfo.name;
            if (userStatusEl) userStatusEl.textContent = userInfo.status;
            if (userAvatarEl) userAvatarEl.src = userInfo.avatar;
            
            // 更新统计信息
            const postsCountEl = document.getElementById('posts-count');
            const friendsCountEl = document.getElementById('friends-count');
            const visitsCountEl = document.getElementById('visits-count');
            
            if (postsCountEl) postsCountEl.textContent = stats.postsCount;
            if (friendsCountEl) friendsCountEl.textContent = stats.friendsCount;
            if (visitsCountEl) visitsCountEl.textContent = stats.visitsCount;
            
            // 渲染动态列表
            renderQzonePosts();
            
            console.log('动态页面渲染完成');
        }
        
        /**
         * 渲染动态列表
         */
        function renderQzonePosts() {
            const postsListEl = document.getElementById('qzone-posts-list');
            if (!postsListEl || !state.qzoneData) return;
            
            const { posts } = state.qzoneData;
            
            // 清空现有内容
            postsListEl.innerHTML = '';
            
            if (posts.length === 0) {
                // 显示空状态
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-posts';
                emptyDiv.innerHTML = '<p>还没有动态，快来发布第一条吧！</p>';
                postsListEl.appendChild(emptyDiv);
                return;
            }
            
            // 按时间倒序排列
            const sortedPosts = posts.sort((a, b) => b.timestamp - a.timestamp);
            
            // 渲染每个动态
            sortedPosts.forEach(post => {
                const postElement = createPostElement(post);
                postsListEl.appendChild(postElement);
            });
        }
        
        /**
         * 创建动态元素
         * @param {Object} post - 动态对象
         * @returns {HTMLElement} 动态元素
         */
        function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post-item';
            postDiv.dataset.postId = post.id;
            
            const timeStr = formatTimestamp(post.timestamp);
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <img src="${post.authorAvatar}" alt="${post.authorName}" class="post-author-avatar">
                    <div class="post-author-info">
                        <div class="post-author-name">${post.authorName}</div>
                        <div class="post-time">${timeStr}</div>
                    </div>
                </div>
                <div class="post-content">${post.content}</div>
                <div class="post-actions-bar">
                    <button class="post-action-btn like-btn" data-post-id="${post.id}">
                        <span>👍</span>
                        <span class="like-count">${post.likes || 0}</span>
                    </button>
                    <button class="post-action-btn comment-btn" data-post-id="${post.id}">
                        <span>💬</span>
                        <span>评论</span>
                    </button>
                    <button class="post-action-btn share-btn" data-post-id="${post.id}">
                        <span>🔗</span>
                        <span>分享</span>
                    </button>
                </div>
            `;
            
            return postDiv;
        }
        
        /**
         * 发布新动态
         */
        function publishPost() {
            const contentInput = document.getElementById('post-content-input');
            if (!contentInput || !state.qzoneData) return;
            
            const content = contentInput.value.trim();
            if (!content) {
                showNotification('请输入动态内容');
                return;
            }
            
            // 创建新动态
            const newPost = {
                id: 'post_' + Date.now(),
                content: content,
                authorName: state.qzoneData.userInfo.name,
                authorAvatar: state.qzoneData.userInfo.avatar,
                timestamp: Date.now(),
                likes: 0,
                comments: []
            };
            
            // 添加到动态列表
            state.qzoneData.posts.unshift(newPost);
            state.qzoneData.stats.postsCount = state.qzoneData.posts.length;
            
            // 保存到localStorage
            localStorage.setItem('qzonePosts', JSON.stringify(state.qzoneData.posts));
            
            // 清空输入框
            contentInput.value = '';
            updatePostSubmitButton();
            
            // 重新渲染
            renderQzoneScreen();
            
            showNotification('动态发布成功！');
            console.log('发布新动态:', newPost);
        }
        
        /**
         * 处理动态点赞
         * @param {string} postId - 动态ID
         */
        function togglePostLike(postId) {
            if (!state.qzoneData) return;
            
            const post = state.qzoneData.posts.find(p => p.id === postId);
            if (!post) return;
            
            // 切换点赞状态
            post.likes = (post.likes || 0) + (post.isLiked ? -1 : 1);
            post.isLiked = !post.isLiked;
            
            // 保存到localStorage
            localStorage.setItem('qzonePosts', JSON.stringify(state.qzoneData.posts));
            
            // 更新UI
            const likeBtn = document.querySelector(`[data-post-id="${postId}"].like-btn`);
            if (likeBtn) {
                const likeCount = likeBtn.querySelector('.like-count');
                if (likeCount) likeCount.textContent = post.likes;
                likeBtn.classList.toggle('liked', post.isLiked);
            }
            
            console.log(`${post.isLiked ? '点赞' : '取消点赞'}动态:`, postId);
        }
        
        /**
         * 更新发布按钮状态
         */
        function updatePostSubmitButton() {
            const contentInput = document.getElementById('post-content-input');
            const submitBtn = document.getElementById('publish-post-btn');
            
            if (!contentInput || !submitBtn) return;
            
            const hasContent = contentInput.value.trim().length > 0;
            submitBtn.disabled = !hasContent;
        }
        
        /**
         * 绑定动态页面事件
         */
        function bindQzoneEvents() {
            // 发布动态按钮
            const publishBtn = document.getElementById('publish-post-btn');
            if (publishBtn) {
                publishBtn.addEventListener('click', publishPost);
            }
            
            // 动态内容输入框
            const contentInput = document.getElementById('post-content-input');
            if (contentInput) {
                contentInput.addEventListener('input', updatePostSubmitButton);
                contentInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        publishPost();
                    }
                });
            }
            
            // 工具按钮事件
            const imageBtn = document.getElementById('post-image-btn');
            if (imageBtn) {
                imageBtn.addEventListener('click', () => {
                    showNotification('图片功能将在后续版本中实现');
                });
            }
            
            const emojiBtn = document.getElementById('post-emoji-btn');
            if (emojiBtn) {
                emojiBtn.addEventListener('click', () => {
                    const emojis = ['😊', '😂', '❤️', '👍', '🎉', '😍', '🤔', '😢'];
                    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                    if (contentInput) {
                        contentInput.value += randomEmoji;
                        updatePostSubmitButton();
                        contentInput.focus();
                    }
                });
            }
            
            const locationBtn = document.getElementById('post-location-btn');
            if (locationBtn) {
                locationBtn.addEventListener('click', () => {
                    showNotification('位置功能将在后续版本中实现');
                });
            }
            
            // 动态操作按钮事件委托
            const postsListEl = document.getElementById('qzone-posts-list');
            if (postsListEl) {
                postsListEl.addEventListener('click', (e) => {
                    const target = e.target.closest('.post-action-btn');
                    if (!target) return;
                    
                    const postId = target.dataset.postId;
                    if (!postId) return;
                    
                    if (target.classList.contains('like-btn')) {
                        togglePostLike(postId);
                    } else if (target.classList.contains('comment-btn')) {
                        showNotification('评论功能将在后续版本中实现');
                    } else if (target.classList.contains('share-btn')) {
                        showNotification('分享功能将在后续版本中实现');
                    }
                });
            }
        }
        
        // ===================================================================
        // 事件绑定
        // ===================================================================
        
        /**
         * 绑定底部导航栏事件
         */
        function bindNavigationEvents() {
            const navItems = document.querySelectorAll('#chat-list-bottom-nav .nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const viewId = item.dataset.view;
                    
                    if (viewId === 'call-history-screen') {
                        // 通话历史是独立页面，不是视图
                        showScreen('call-history-screen');
                        console.log('进入通话历史页面');
                    } else {
                        // 其他是聊天列表内的视图切换
                        switchToChatListView(viewId);
                    }
                });
            });
        }
        
        /**
         * 绑定用户头像交互事件
         */
        function bindUserAvatarEvents() {
            const userAvatar = document.getElementById('user-avatar');
            const userDropdownMenu = document.getElementById('user-dropdown-menu');
            
            if (!userAvatar || !userDropdownMenu) return;
            
            // 头像点击事件
            userAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleUserDropdownMenu();
            });
            
            // 点击页面其他地方关闭菜单
            document.addEventListener('click', (e) => {
                if (!userDropdownMenu.contains(e.target) && e.target !== userAvatar) {
                    hideUserDropdownMenu();
                }
            });
            
            // 绑定菜单项点击事件
            bindUserDropdownMenuItems();
        }
        
        /**
         * 切换用户下拉菜单显示状态
         */
        function toggleUserDropdownMenu() {
            const userDropdownMenu = document.getElementById('user-dropdown-menu');
            if (userDropdownMenu) {
                const isVisible = userDropdownMenu.classList.contains('visible');
                if (isVisible) {
                    hideUserDropdownMenu();
                } else {
                    showUserDropdownMenu();
                }
            }
        }
        
        /**
         * 显示用户下拉菜单
         */
        function showUserDropdownMenu() {
            const userDropdownMenu = document.getElementById('user-dropdown-menu');
            if (userDropdownMenu) {
                userDropdownMenu.classList.add('visible');
                console.log('显示用户下拉菜单');
            }
        }
        
        /**
         * 隐藏用户下拉菜单
         */
        function hideUserDropdownMenu() {
            const userDropdownMenu = document.getElementById('user-dropdown-menu');
            if (userDropdownMenu) {
                userDropdownMenu.classList.remove('visible');
            }
        }
        
        /**
         * 绑定用户下拉菜单项事件
         */
        function bindUserDropdownMenuItems() {
            // API设置
            const apiSettingsBtn = document.getElementById('dropdown-api-settings');
            if (apiSettingsBtn) {
                apiSettingsBtn.addEventListener('click', () => {
                    hideUserDropdownMenu();
                    showScreen('api-settings-screen');
                    console.log('进入API设置页面');
                });
            }
            
            // 外观设置
            const appearanceSettingsBtn = document.getElementById('dropdown-appearance-settings');
            if (appearanceSettingsBtn) {
                appearanceSettingsBtn.addEventListener('click', () => {
                    hideUserDropdownMenu();
                    showScreen('wallpaper-screen');
                    console.log('进入外观设置页面');
                });
            }
            
            // 字体设置
            const fontSettingsBtn = document.getElementById('dropdown-font-settings');
            if (fontSettingsBtn) {
                fontSettingsBtn.addEventListener('click', () => {
                    hideUserDropdownMenu();
                    showScreen('font-settings-screen');
                    console.log('进入字体设置页面');
                });
            }
            
            // 世界书
            const worldBookBtn = document.getElementById('dropdown-world-book');
            if (worldBookBtn) {
                worldBookBtn.addEventListener('click', () => {
                    hideUserDropdownMenu();
                    showScreen('world-book-screen');
                    console.log('进入世界书页面');
                });
            }
            
            // 回忆
            const memoriesBtn = document.getElementById('dropdown-memories');
            if (memoriesBtn) {
                memoriesBtn.addEventListener('click', () => {
                    hideUserDropdownMenu();
                    switchToChatListView('memories-view');
                    console.log('切换到回忆视图');
                });
            }
            
            // 收藏
            const favoritesBtn = document.getElementById('dropdown-favorites');
            if (favoritesBtn) {
                favoritesBtn.addEventListener('click', () => {
                    hideUserDropdownMenu();
                    switchToChatListView('favorites-view');
                    console.log('切换到收藏视图');
                });
            }
            
            // 更换头像
            const changeAvatarBtn = document.getElementById('dropdown-change-avatar');
            if (changeAvatarBtn) {
                changeAvatarBtn.addEventListener('click', () => {
                    hideUserDropdownMenu();
                    // 创建文件输入元素
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*';
                    fileInput.style.display = 'none';
                    
                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const userAvatar = document.getElementById('user-avatar');
                                if (userAvatar) {
                                    userAvatar.src = e.target.result;
                                    console.log('用户头像已更新');
                                }
                            };
                            reader.readAsDataURL(file);
                        }
                        document.body.removeChild(fileInput);
                    });
                    
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    console.log('打开头像选择器');
                });
            }
            
            // 聊天背景
            const chatListBgBtn = document.getElementById('dropdown-chat-list-bg');
            if (chatListBgBtn) {
                chatListBgBtn.addEventListener('click', () => {
                    hideUserDropdownMenu();
                    showScreen('chat-list-bg-screen');
                    console.log('进入聊天背景设置页面');
                });
            }
        }
        
        /**
         * 绑定群聊/单聊切换事件
         */
        function bindChatTypeToggleEvents() {
            const chatTypeToggle = document.getElementById('chat-type-toggle');
            if (!chatTypeToggle) return;
            
            // 单击切换过滤类型
            chatTypeToggle.addEventListener('click', (e) => {
                if (e.target.classList.contains('toggle-btn')) {
                    // 移除所有按钮的active类
                    const allToggleBtns = document.querySelectorAll('.toggle-btn');
                    allToggleBtns.forEach(btn => btn.classList.remove('active'));
                    
                    // 为点击的按钮添加active类
                    e.target.classList.add('active');
                    
                    // 重新渲染聊天列表
                    renderChatList();
                    
                    const filterType = e.target.dataset.type;
                    console.log(`切换聊天过滤类型: ${filterType}`);
                }
            });
            
            // 双击进入通话历史（快捷功能）
            chatTypeToggle.addEventListener('dblclick', () => {
                showScreen('call-history-screen');
                console.log('双击进入通话历史页面');
            });
        }
        
        /**
         * 获取当前选中的聊天过滤类型
         * @returns {string} 过滤类型 ('all', 'single', 'group')
         */
        function getCurrentChatFilterType() {
            const activeToggle = document.querySelector('.toggle-btn.active');
            return activeToggle ? activeToggle.dataset.type : 'all';
        }
        
        /**
         * 设置聊天过滤类型
         * @param {string} filterType - 过滤类型 ('all', 'single', 'group')
         */
        function setChatFilterType(filterType) {
            const toggleBtns = document.querySelectorAll('.toggle-btn');
            toggleBtns.forEach(btn => {
                const isActive = btn.dataset.type === filterType;
                btn.classList.toggle('active', isActive);
            });
            
            renderChatList();
            console.log(`设置聊天过滤类型: ${filterType}`);
        }
        
        /**
         * 绑定添加功能交互事件
         */
        function bindAddMenuEvents() {
            const addMenuBtn = document.getElementById('add-menu-btn');
            const addDropdownMenu = document.getElementById('add-dropdown-menu');
            
            if (!addMenuBtn || !addDropdownMenu) return;
            
            // 添加按钮点击事件
            addMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleAddDropdownMenu();
            });
            
            // 点击页面其他地方关闭菜单
            document.addEventListener('click', (e) => {
                if (!addDropdownMenu.contains(e.target) && e.target !== addMenuBtn) {
                    hideAddDropdownMenu();
                }
            });
            
            // 绑定添加菜单项事件
            bindAddMenuItems();
        }
        
        /**
         * 切换添加下拉菜单显示状态
         */
        function toggleAddDropdownMenu() {
            const addDropdownMenu = document.getElementById('add-dropdown-menu');
            if (addDropdownMenu) {
                const isVisible = addDropdownMenu.classList.contains('visible');
                if (isVisible) {
                    hideAddDropdownMenu();
                } else {
                    showAddDropdownMenu();
                }
            }
        }
        
        /**
         * 显示添加下拉菜单
         */
        function showAddDropdownMenu() {
            const addDropdownMenu = document.getElementById('add-dropdown-menu');
            if (addDropdownMenu) {
                addDropdownMenu.classList.add('visible');
                console.log('显示添加下拉菜单');
            }
        }
        
        /**
         * 隐藏添加下拉菜单
         */
        function hideAddDropdownMenu() {
            const addDropdownMenu = document.getElementById('add-dropdown-menu');
            if (addDropdownMenu) {
                addDropdownMenu.classList.remove('visible');
            }
        }
        
        /**
         * 绑定添加菜单项事件
         */
        function bindAddMenuItems() {
            // 添加好友
            const addFriendBtn = document.getElementById('add-friend-btn');
            if (addFriendBtn) {
                addFriendBtn.addEventListener('click', async () => {
                    hideAddDropdownMenu();
                    await handleAddFriend();
                });
            }
            
            // 创建群聊
            const addGroupChatBtn = document.getElementById('add-group-chat-btn');
            if (addGroupChatBtn) {
                addGroupChatBtn.addEventListener('click', async () => {
                    hideAddDropdownMenu();
                    await handleCreateGroupChat();
                });
            }
        }
        
        /**
         * 处理添加好友功能
         */
        async function handleAddFriend() {
            const name = await showCustomPrompt('添加好友', '请输入Ta的名字');
            if (name && name.trim()) {
                const newChatId = 'chat_' + Date.now();
                const newChat = {
                    id: newChatId,
                    name: name.trim(),
                    isGroup: false,
                    avatar: defaultAvatar,
                    lastMessage: '[在线]',
                    timestamp: Date.now(),
                    unreadCount: 0,
                    status: { text: '在线', lastUpdate: Date.now() },
                    history: []
                };
                
                addChat(newChat);
                console.log(`添加好友成功: ${name.trim()}`);
                
                // 显示成功提示
                showNotification(`已添加好友 "${name.trim()}"`);
            }
        }
        
        /**
         * 处理创建群聊功能
         */
        async function handleCreateGroupChat() {
            // 首先选择群聊成员
            const members = await selectGroupMembers();
            if (!members || members.length < 2) {
                showNotification('创建群聊至少需要选择2个成员');
                return;
            }
            
            // 设置群聊名称
            const groupName = await showCustomPrompt('设置群名', '请输入群聊的名字', '我们的群聊');
            if (!groupName || !groupName.trim()) {
                return;
            }
            
            const newChatId = 'group_' + Date.now();
            const newGroupChat = {
                id: newChatId,
                name: groupName.trim(),
                isGroup: true,
                avatar: defaultGroupAvatar,
                lastMessage: '群聊已创建',
                timestamp: Date.now(),
                unreadCount: 0,
                members: members,
                history: [
                    {
                        role: 'system',
                        content: '群聊已创建',
                        timestamp: Date.now()
                    }
                ]
            };
            
            addChat(newGroupChat);
            console.log(`创建群聊成功: ${groupName.trim()}`);
            
            // 显示成功提示
            showNotification(`群聊 "${groupName.trim()}" 创建成功`);
        }
        
        /**
         * 选择群聊成员（简化版本）
         * @returns {Promise<Array>} 选中的成员数组
         */
        async function selectGroupMembers() {
            // 获取所有单聊好友作为候选成员
            const friends = Object.values(state.chats).filter(chat => !chat.isGroup);
            
            if (friends.length === 0) {
                showNotification('暂无好友可添加到群聊');
                return null;
            }
            
            // 简化版本：随机选择2个好友
            const selectedMembers = [];
            const shuffled = friends.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, Math.min(2, friends.length));
            
            selected.forEach(friend => {
                selectedMembers.push({
                    id: friend.id,
                    name: friend.name,
                    avatar: friend.avatar || defaultAvatar
                });
            });
            
            return selectedMembers;
        }
        
        /**
         * 显示自定义输入对话框
         * @param {string} title - 对话框标题
         * @param {string} message - 提示信息
         * @param {string} defaultValue - 默认值
         * @returns {Promise<string>} 用户输入的内容
         */
        function showCustomPrompt(title, message, defaultValue = '') {
            return new Promise((resolve) => {
                const input = prompt(`${title}\n${message}`, defaultValue);
                resolve(input);
            });
        }
        
        /**
         * 显示通知消息
         * @param {string} message - 通知内容
         */
        function showNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 10000;
                transition: opacity 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3秒后自动消失
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        /**
         * 绑定聊天界面事件
         */
        function bindChatInterfaceEvents() {
            // 返回按钮
            const chatBackBtn = document.getElementById('chat-back-btn');
            if (chatBackBtn) {
                chatBackBtn.addEventListener('click', () => {
                    showScreen('chat-list-screen');
                });
            }
            
            // 设置按钮
            const chatSettingsBtn = document.getElementById('chat-settings-btn');
            if (chatSettingsBtn) {
                chatSettingsBtn.addEventListener('click', () => {
                    console.log('打开聊天设置');
                    // 后续任务中实现聊天设置功能
                });
            }
            
            // 绑定输入功能
            bindChatInputEvents();
        }
        
        /**
         * 绑定聊天输入事件
         */
        function bindChatInputEvents() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (!chatInput || !sendBtn) return;
            
            // 发送按钮点击事件
            sendBtn.addEventListener('click', () => {
                sendMessage();
            });
            
            // 输入框回车发送
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 输入框自动调整高度
            chatInput.addEventListener('input', () => {
                autoResizeTextarea(chatInput);
                updateSendButtonState();
            });
            
            // 初始化发送按钮状态
            updateSendButtonState();
            
            // 绑定功能按钮事件
            bindChatActionButtons();
        }
        
        /**
         * 绑定聊天功能按钮事件
         */
        function bindChatActionButtons() {
            // 切换功能按钮显示
            const toggleActionsBtn = document.getElementById('toggle-actions-btn');
            if (toggleActionsBtn) {
                toggleActionsBtn.addEventListener('click', () => {
                    toggleChatActions();
                });
            }
            
            // 表情按钮
            const emojiBtn = document.getElementById('emoji-btn');
            if (emojiBtn) {
                emojiBtn.addEventListener('click', () => {
                    handleEmojiClick();
                });
            }
            
            // 图片按钮
            const imageBtn = document.getElementById('image-btn');
            if (imageBtn) {
                imageBtn.addEventListener('click', () => {
                    handleImageClick();
                });
            }
            
            // 文件按钮
            const fileBtn = document.getElementById('file-btn');
            if (fileBtn) {
                fileBtn.addEventListener('click', () => {
                    handleFileClick();
                });
            }
            
            // 语音按钮
            const voiceBtn = document.getElementById('voice-btn');
            if (voiceBtn) {
                voiceBtn.addEventListener('click', () => {
                    handleVoiceClick();
                });
            }
        }
        
        /**
         * 切换聊天功能按钮显示状态
         */
        function toggleChatActions() {
            const actionsContainer = document.getElementById('chat-input-actions');
            const toggleBtn = document.getElementById('toggle-actions-btn');
            
            if (!actionsContainer || !toggleBtn) return;
            
            const isVisible = actionsContainer.classList.contains('visible');
            
            if (isVisible) {
                // 隐藏功能按钮
                actionsContainer.classList.remove('visible');
                toggleBtn.classList.remove('expanded');
                console.log('隐藏聊天功能按钮');
            } else {
                // 显示功能按钮
                actionsContainer.classList.add('visible');
                toggleBtn.classList.add('expanded');
                console.log('显示聊天功能按钮');
            }
        }
        
        /**
         * 处理表情按钮点击
         */
        function handleEmojiClick() {
            const emojis = ['😊', '😂', '❤️', '👍', '👎', '😢', '😮', '😡', '🎉', '🤔'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.value += randomEmoji;
                autoResizeTextarea(chatInput);
                updateSendButtonState();
                chatInput.focus();
            }
            
            console.log(`插入表情: ${randomEmoji}`);
        }
        
        /**
         * 处理图片按钮点击
         */
        function handleImageClick() {
            // 创建文件输入元素
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && state.activeChatId) {
                    const chat = state.chats[state.activeChatId];
                    if (chat) {
                        // 创建图片消息
                        const imageMessage = {
                            role: 'user',
                            type: 'user_photo',
                            content: `发送了图片: ${file.name}`,
                            timestamp: Date.now()
                        };
                        
                        if (chat.isGroup) {
                            imageMessage.senderName = '我';
                        }
                        
                        // 添加到聊天历史
                        chat.history.push(imageMessage);
                        updateChatLastMessage(chat.id, '[图片]', chat.isGroup ? '我' : null);
                        
                        // 显示消息
                        appendMessage(imageMessage, chat);
                        
                        console.log(`发送图片: ${file.name}`);
                    }
                }
                document.body.removeChild(fileInput);
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        /**
         * 处理文件按钮点击
         */
        function handleFileClick() {
            // 创建文件输入元素
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && state.activeChatId) {
                    const chat = state.chats[state.activeChatId];
                    if (chat) {
                        // 创建文件消息
                        const fileMessage = {
                            role: 'user',
                            type: 'file',
                            content: `发送了文件: ${file.name}`,
                            timestamp: Date.now()
                        };
                        
                        if (chat.isGroup) {
                            fileMessage.senderName = '我';
                        }
                        
                        // 添加到聊天历史
                        chat.history.push(fileMessage);
                        updateChatLastMessage(chat.id, '[文件]', chat.isGroup ? '我' : null);
                        
                        // 显示消息
                        appendMessage(fileMessage, chat);
                        
                        console.log(`发送文件: ${file.name}`);
                    }
                }
                document.body.removeChild(fileInput);
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        /**
         * 处理语音按钮点击
         */
        function handleVoiceClick() {
            if (!state.activeChatId) return;
            
            const chat = state.chats[state.activeChatId];
            if (chat) {
                // 创建语音消息
                const voiceMessage = {
                    role: 'user',
                    type: 'voice_message',
                    content: '发送了一条语音消息',
                    timestamp: Date.now()
                };
                
                if (chat.isGroup) {
                    voiceMessage.senderName = '我';
                }
                
                // 添加到聊天历史
                chat.history.push(voiceMessage);
                updateChatLastMessage(chat.id, '[语音]', chat.isGroup ? '我' : null);
                
                // 显示消息
                appendMessage(voiceMessage, chat);
                
                console.log('发送语音消息');
                showNotification('语音消息发送成功');
            }
        }
        
        /**
         * 发送消息
         */
        function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (!chatInput || !sendBtn || !state.activeChatId) return;
            
            const messageContent = chatInput.value.trim();
            if (!messageContent) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
            
            // 创建用户消息
            const userMessage = {
                role: 'user',
                content: messageContent,
                timestamp: Date.now()
            };
            
            // 群聊中添加发送者名称
            if (chat.isGroup) {
                userMessage.senderName = '我';
            }
            
            // 添加到聊天历史
            chat.history.push(userMessage);
            
            // 更新聊天的最后消息和时间戳
            updateChatLastMessage(chat.id, messageContent, chat.isGroup ? '我' : null);
            
            // 显示消息
            appendMessage(userMessage, chat);
            
            // 清空输入框
            chatInput.value = '';
            autoResizeTextarea(chatInput);
            updateSendButtonState();
            
            // 模拟AI回复（简化版本）
            if (!chat.isGroup) {
                setTimeout(() => {
                    simulateAIReply(chat);
                }, 1000 + Math.random() * 2000); // 1-3秒随机延迟
            }
            
            console.log(`发送消息: ${messageContent}`);
        }
        
        /**
         * 模拟AI回复
         * @param {Object} chat - 聊天对象
         */
        function simulateAIReply(chat) {
            const aiReplies = [
                '我明白了，让我想想...',
                '这是一个很有趣的问题！',
                '谢谢你的分享！',
                '我会记住这个信息的。',
                '还有什么其他问题吗？',
                '让我们继续聊聊吧！',
                '这听起来很不错！',
                '我同意你的观点。',
                '这确实值得思考。',
                '你说得很有道理！'
            ];
            
            const randomReply = aiReplies[Math.floor(Math.random() * aiReplies.length)];
            
            const aiMessage = {
                role: 'ai',
                content: randomReply,
                timestamp: Date.now()
            };
            
            // 添加到聊天历史
            chat.history.push(aiMessage);
            
            // 更新聊天的最后消息
            updateChatLastMessage(chat.id, randomReply);
            
            // 只有在当前查看这个聊天时才显示消息
            if (state.activeChatId === chat.id) {
                appendMessage(aiMessage, chat);
            }
            
            console.log(`AI回复: ${randomReply}`);
        }
        
        /**
         * 自动调整文本框高度
         * @param {HTMLTextAreaElement} textarea - 文本框元素
         */
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 100); // 最大高度100px
            textarea.style.height = newHeight + 'px';
        }
        
        /**
         * 更新发送按钮状态
         */
        function updateSendButtonState() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (!chatInput || !sendBtn) return;
            
            const hasContent = chatInput.value.trim().length > 0;
            sendBtn.disabled = !hasContent || !state.activeChatId;
            
            if (hasContent && state.activeChatId) {
                sendBtn.style.backgroundColor = 'var(--accent-color)';
                sendBtn.style.cursor = 'pointer';
            } else {
                sendBtn.style.backgroundColor = '#ccc';
                sendBtn.style.cursor = 'not-allowed';
            }
        }
        
        // ===================================================================
        // 世界书功能
        // ===================================================================
        
        // 当前编辑的世界书ID
        let editingWorldBookId = null;
        
        /**
         * 初始化世界书数据
         */
        function initializeWorldBooks() {
            // 从localStorage加载世界书数据
            const savedWorldBooks = localStorage.getItem('worldBooks');
            if (savedWorldBooks) {
                state.worldBooks = JSON.parse(savedWorldBooks);
            } else {
                state.worldBooks = [];
            }
        }
        
        /**
         * 渲染世界书列表
         */
        function renderWorldBookList() {
            const listEl = document.getElementById('world-book-list');
            if (!listEl) return;
            
            // 清空现有内容
            listEl.innerHTML = '';
            
            if (!state.worldBooks || state.worldBooks.length === 0) {
                // 显示空状态
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-world-books';
                emptyDiv.innerHTML = `
                    <p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                        还没有世界书条目，点击右上角 + 号添加
                    </p>
                `;
                listEl.appendChild(emptyDiv);
                return;
            }
            
            // 按优先级排序
            const sortedBooks = [...state.worldBooks].sort((a, b) => (b.priority || 2) - (a.priority || 2));
            
            // 渲染世界书条目
            sortedBooks.forEach(book => {
                const item = createWorldBookItem(book);
                listEl.appendChild(item);
            });
        }
        
        /**
         * 创建世界书条目元素
         * @param {Object} book - 世界书对象
         * @returns {HTMLElement} 世界书条目元素
         */
        function createWorldBookItem(book) {
            const item = document.createElement('div');
            item.className = `world-book-item ${book.enabled === false ? 'disabled' : ''}`;
            item.dataset.bookId = book.id;
            
            // 优先级显示
            const priorityClass = book.priority === 3 ? 'priority-high' : 
                                 book.priority === 1 ? 'priority-low' : 'priority-medium';
            const priorityText = book.priority === 3 ? '高' : 
                                book.priority === 1 ? '低' : '中';
            
            // 关键词标签
            const keywordsHtml = book.keywords ? 
                book.keywords.split(',').map(keyword => 
                    `<span class="keyword-tag">${keyword.trim()}</span>`
                ).join('') : '';
            
            // 内容预览
            const preview = book.content ? book.content.substring(0, 100) + (book.content.length > 100 ? '...' : '') : '暂无内容';
            
            item.innerHTML = `
                <div class="world-book-header">
                    <h3 class="world-book-name">${book.name}</h3>
                    <span class="world-book-priority ${priorityClass}">${priorityText}</span>
                </div>
                <div class="world-book-keywords">${keywordsHtml}</div>
                <div class="world-book-preview">${preview}</div>
            `;
            
            // 绑定点击事件
            item.addEventListener('click', () => {
                openWorldBookEditor(book.id);
            });
            
            return item;
        }
        
        /**
         * 打开世界书编辑器
         * @param {string} bookId - 世界书ID，null表示新建
         */
        function openWorldBookEditor(bookId = null) {
            editingWorldBookId = bookId;
            
            const titleEl = document.getElementById('world-book-editor-title');
            const deleteBtn = document.getElementById('delete-world-book-btn');
            
            if (bookId) {
                // 编辑模式
                const book = state.worldBooks.find(b => b.id === bookId);
                if (!book) return;
                
                titleEl.textContent = `编辑: ${book.name}`;
                deleteBtn.style.display = 'block';
                
                // 填充表单
                document.getElementById('world-book-name-input').value = book.name || '';
                document.getElementById('world-book-keywords-input').value = book.keywords || '';
                document.getElementById('world-book-content-input').value = book.content || '';
                document.getElementById('world-book-priority').value = book.priority || 2;
                document.getElementById('world-book-enabled').checked = book.enabled !== false;
            } else {
                // 新建模式
                titleEl.textContent = '新建世界书';
                deleteBtn.style.display = 'none';
                
                // 清空表单
                document.getElementById('world-book-name-input').value = '';
                document.getElementById('world-book-keywords-input').value = '';
                document.getElementById('world-book-content-input').value = '';
                document.getElementById('world-book-priority').value = '2';
                document.getElementById('world-book-enabled').checked = true;
            }
            
            showScreen('world-book-editor-screen');
        }
        
        /**
         * 保存世界书
         */
        function saveWorldBook() {
            const name = document.getElementById('world-book-name-input').value.trim();
            const keywords = document.getElementById('world-book-keywords-input').value.trim();
            const content = document.getElementById('world-book-content-input').value.trim();
            const priority = parseInt(document.getElementById('world-book-priority').value);
            const enabled = document.getElementById('world-book-enabled').checked;
            
            if (!name) {
                showNotification('请输入条目名称');
                return;
            }
            
            if (!content) {
                showNotification('请输入条目内容');
                return;
            }
            
            const bookData = {
                name,
                keywords,
                content,
                priority,
                enabled,
                updatedAt: Date.now()
            };
            
            if (editingWorldBookId) {
                // 更新现有条目
                const bookIndex = state.worldBooks.findIndex(b => b.id === editingWorldBookId);
                if (bookIndex !== -1) {
                    state.worldBooks[bookIndex] = { ...state.worldBooks[bookIndex], ...bookData };
                }
            } else {
                // 创建新条目
                bookData.id = 'wb_' + Date.now();
                bookData.createdAt = Date.now();
                state.worldBooks.push(bookData);
            }
            
            // 保存到localStorage
            DataStorage.save(DataStorage.KEYS.WORLD_BOOKS, state.worldBooks);
            
            showNotification('世界书保存成功！');
            showScreen('world-book-screen');
            renderWorldBookList();
            
            console.log('保存世界书:', bookData);
        }
        
        /**
         * 删除世界书
         */
        async function deleteWorldBook() {
            if (!editingWorldBookId) return;
            
            const book = state.worldBooks.find(b => b.id === editingWorldBookId);
            if (!book) return;
            
            const confirmed = confirm(`确定要删除《${book.name}》吗？此操作不可撤销。`);
            
            if (confirmed) {
                // 从数组中移除
                state.worldBooks = state.worldBooks.filter(b => b.id !== editingWorldBookId);
                
                // 保存到localStorage
                DataStorage.save(DataStorage.KEYS.WORLD_BOOKS, state.worldBooks);
                
                showNotification('世界书已删除');
                showScreen('world-book-screen');
                renderWorldBookList();
                
                console.log('删除世界书:', book.name);
            }
        }
        
        /**
         * 根据关键词匹配世界书条目
         * @param {string} text - 要匹配的文本
         * @returns {Array} 匹配的世界书条目
         */
        function matchWorldBooks(text) {
            if (!state.worldBooks || !text) return [];
            
            const matches = [];
            const enabledBooks = state.worldBooks.filter(book => book.enabled !== false);
            
            enabledBooks.forEach(book => {
                if (book.keywords) {
                    const keywords = book.keywords.split(',').map(k => k.trim());
                    const hasMatch = keywords.some(keyword => 
                        keyword && text.toLowerCase().includes(keyword.toLowerCase())
                    );
                    
                    if (hasMatch) {
                        matches.push(book);
                    }
                }
            });
            
            // 按优先级排序
            return matches.sort((a, b) => (b.priority || 2) - (a.priority || 2));
        }
        
        /**
         * 绑定世界书页面事件
         */
        function bindWorldBookEvents() {
            // 世界书页面返回按钮
            const worldBookBackBtn = document.getElementById('world-book-back-btn');
            if (worldBookBackBtn) {
                worldBookBackBtn.addEventListener('click', () => {
                    showScreen('chat-list-screen');
                });
            }
            
            // 添加世界书按钮
            const addBtn = document.getElementById('add-world-book-btn');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    openWorldBookEditor();
                });
            }
            
            // 保存按钮
            const saveBtn = document.getElementById('save-world-book-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveWorldBook);
            }
            
            // 删除按钮
            const deleteBtn = document.getElementById('delete-world-book-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', deleteWorldBook);
            }
            
            // 编辑器返回按钮
            const editorBackBtn = document.getElementById('world-book-editor-back-btn');
            if (editorBackBtn) {
                editorBackBtn.addEventListener('click', () => {
                    showScreen('world-book-screen');
                });
            }
        }
        
        // ===================================================================
        // 聊天历史功能
        // ===================================================================
        
        // 当前历史过滤器
        let currentHistoryFilter = 'all';
        let currentHistorySearch = '';
        
        /**
         * 渲染聊天历史列表
         */
        function renderChatHistoryList() {
            const listEl = document.getElementById('chat-history-list');
            if (!listEl) return;
            
            // 清空现有内容
            listEl.innerHTML = '';
            
            // 获取所有有历史记录的聊天
            const chatsWithHistory = Object.values(state.chats).filter(chat => 
                chat.history && chat.history.length > 0
            );
            
            if (chatsWithHistory.length === 0) {
                // 显示空状态
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-history';
                emptyDiv.innerHTML = `
                    <p style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                        暂无聊天历史记录
                    </p>
                `;
                listEl.appendChild(emptyDiv);
                return;
            }
            
            // 过滤和搜索
            let filteredChats = filterChatHistory(chatsWithHistory);
            
            // 按最后消息时间排序
            filteredChats.sort((a, b) => {
                const aLastTime = a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
                const bLastTime = b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
                return bLastTime - aLastTime;
            });
            
            // 渲染历史记录项
            filteredChats.forEach(chat => {
                const item = createHistoryItem(chat);
                listEl.appendChild(item);
            });
        }
        
        /**
         * 过滤聊天历史
         * @param {Array} chats - 聊天数组
         * @returns {Array} 过滤后的聊天数组
         */
        function filterChatHistory(chats) {
            let filtered = [...chats];
            
            // 时间过滤
            if (currentHistoryFilter !== 'all') {
                const now = Date.now();
                const timeFilters = {
                    'today': now - 24 * 60 * 60 * 1000,
                    'week': now - 7 * 24 * 60 * 60 * 1000,
                    'month': now - 30 * 24 * 60 * 60 * 1000
                };
                
                const filterTime = timeFilters[currentHistoryFilter];
                if (filterTime) {
                    filtered = filtered.filter(chat => {
                        const lastMessage = chat.history[chat.history.length - 1];
                        return lastMessage && lastMessage.timestamp >= filterTime;
                    });
                }
            }
            
            // 搜索过滤
            if (currentHistorySearch) {
                const searchLower = currentHistorySearch.toLowerCase();
                filtered = filtered.filter(chat => {
                    // 搜索聊天名称
                    if (chat.name.toLowerCase().includes(searchLower)) {
                        return true;
                    }
                    
                    // 搜索消息内容
                    return chat.history.some(message => 
                        message.content && message.content.toLowerCase().includes(searchLower)
                    );
                });
            }
            
            return filtered;
        }
        
        /**
         * 创建历史记录项元素
         * @param {Object} chat - 聊天对象
         * @returns {HTMLElement} 历史记录项元素
         */
        function createHistoryItem(chat) {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.dataset.chatId = chat.id;
            
            const lastMessage = chat.history[chat.history.length - 1];
            const messageCount = chat.history.length;
            const timeSpan = getTimeSpan(chat.history);
            
            // 最后消息预览
            let preview = '暂无消息';
            if (lastMessage) {
                if (lastMessage.type === 'user_photo') {
                    preview = '[图片]';
                } else if (lastMessage.type === 'voice_message') {
                    preview = '[语音]';
                } else if (lastMessage.type === 'file') {
                    preview = '[文件]';
                } else {
                    preview = lastMessage.content || '暂无内容';
                }
            }
            
            item.innerHTML = `
                <div class="history-item-header">
                    <img src="${chat.avatar}" class="history-item-avatar" alt="${chat.name}">
                    <div class="history-item-info">
                        <div class="history-item-name">${chat.name}</div>
                        <div class="history-item-time">${formatTimestamp(lastMessage?.timestamp || Date.now())}</div>
                    </div>
                    <div class="history-item-stats">
                        ${messageCount} 条消息<br>
                        ${timeSpan}
                    </div>
                </div>
                <div class="history-item-preview">${preview}</div>
            `;
            
            // 绑定点击事件
            item.addEventListener('click', () => {
                openHistoryDetail(chat.id);
            });
            
            return item;
        }
        
        /**
         * 获取聊天时间跨度
         * @param {Array} history - 聊天历史
         * @returns {string} 时间跨度描述
         */
        function getTimeSpan(history) {
            if (!history || history.length === 0) return '-';
            
            const firstTime = history[0].timestamp;
            const lastTime = history[history.length - 1].timestamp;
            const diffDays = Math.ceil((lastTime - firstTime) / (24 * 60 * 60 * 1000));
            
            if (diffDays <= 1) return '1天内';
            if (diffDays <= 7) return `${diffDays}天`;
            if (diffDays <= 30) return `${Math.ceil(diffDays / 7)}周`;
            return `${Math.ceil(diffDays / 30)}个月`;
        }
        
        /**
         * 打开历史记录详情
         * @param {string} chatId - 聊天ID
         */
        function openHistoryDetail(chatId) {
            const chat = state.chats[chatId];
            if (!chat) return;
            
            // 更新详情页面信息
            document.getElementById('history-detail-title').textContent = `${chat.name} - 聊天详情`;
            document.getElementById('history-detail-avatar').src = chat.avatar;
            document.getElementById('history-detail-name').textContent = chat.name;
            
            const messageCount = chat.history.length;
            const timeSpan = getTimeSpan(chat.history);
            document.getElementById('history-detail-stats').textContent = 
                `消息数量: ${messageCount} | 时间跨度: ${timeSpan}`;
            
            // 渲染历史消息
            renderHistoryMessages(chat);
            
            // 显示详情页面
            showScreen('history-detail-screen');
        }
        
        /**
         * 渲染历史消息
         * @param {Object} chat - 聊天对象
         */
        function renderHistoryMessages(chat) {
            const container = document.getElementById('history-messages-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            chat.history.forEach(message => {
                const messageEl = createHistoryMessageElement(message, chat);
                container.appendChild(messageEl);
            });
            
            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }
        
        /**
         * 创建历史消息元素
         * @param {Object} message - 消息对象
         * @param {Object} chat - 聊天对象
         * @returns {HTMLElement} 消息元素
         */
        function createHistoryMessageElement(message, chat) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `history-message ${message.role === 'user' ? 'user' : 'ai'}`;
            
            const avatarSrc = message.role === 'user' ? 
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 24 24' fill='%23007bff'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" : 
                chat.avatar;
            
            let content = message.content || '';
            if (message.type === 'user_photo') {
                content = '📷 ' + content;
            } else if (message.type === 'voice_message') {
                content = '🎤 ' + content;
            } else if (message.type === 'file') {
                content = '📎 ' + content;
            }
            
            messageDiv.innerHTML = `
                <img src="${avatarSrc}" class="history-message-avatar" alt="头像">
                <div class="history-message-content">
                    <p class="history-message-text">${content}</p>
                    <div class="history-message-time">${formatTimestamp(message.timestamp)}</div>
                </div>
            `;
            
            return messageDiv;
        }
        
        /**
         * 切换历史过滤器
         * @param {string} filter - 过滤器类型
         */
        function switchHistoryFilter(filter) {
            currentHistoryFilter = filter;
            
            // 更新按钮状态
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });
            
            // 重新渲染列表
            renderChatHistoryList();
        }
        
        /**
         * 切换搜索显示状态
         */
        function toggleHistorySearch() {
            const searchContainer = document.getElementById('history-search-container');
            const searchInput = document.getElementById('history-search-input');
            
            if (searchContainer.style.display === 'none') {
                searchContainer.style.display = 'block';
                searchInput.focus();
            } else {
                searchContainer.style.display = 'none';
                searchInput.value = '';
                currentHistorySearch = '';
                renderChatHistoryList();
            }
        }
        
        /**
         * 执行历史搜索
         * @param {string} query - 搜索查询
         */
        function searchHistory(query) {
            currentHistorySearch = query;
            renderChatHistoryList();
        }
        
        /**
         * 清空聊天历史
         */
        async function clearChatHistory() {
            const confirmed = confirm('确定要清空所有聊天历史吗？此操作不可撤销。');
            
            if (confirmed) {
                // 清空所有聊天的历史记录
                Object.values(state.chats).forEach(chat => {
                    chat.history = [];
                    chat.lastMessage = '';
                    chat.lastMessageTime = null;
                });
                
                // 保存到localStorage
                DataStorage.save(DataStorage.KEYS.CHATS, state.chats);
                
                // 重新渲染
                renderChatHistoryList();
                renderChatList();
                
                showNotification('聊天历史已清空');
                console.log('清空聊天历史');
            }
        }
        
        /**
         * 导出聊天历史
         * @param {string} chatId - 聊天ID（可选，不传则导出所有）
         */
        function exportChatHistory(chatId = null) {
            let exportData;
            let filename;
            
            if (chatId) {
                // 导出单个聊天
                const chat = state.chats[chatId];
                if (!chat) return;
                
                exportData = {
                    chatName: chat.name,
                    isGroup: chat.isGroup,
                    exportTime: new Date().toISOString(),
                    messages: chat.history
                };
                filename = `${chat.name}_聊天记录.json`;
            } else {
                // 导出所有聊天
                exportData = {
                    exportTime: new Date().toISOString(),
                    chats: Object.values(state.chats).map(chat => ({
                        name: chat.name,
                        isGroup: chat.isGroup,
                        messages: chat.history
                    }))
                };
                filename = '全部聊天记录.json';
            }
            
            // 创建下载链接
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('聊天记录导出成功');
            console.log('导出聊天记录:', filename);
        }
        
        /**
         * 绑定聊天历史页面事件
         */
        function bindChatHistoryEvents() {
            // 返回按钮
            const historyBackBtn = document.getElementById('chat-history-back-btn');
            if (historyBackBtn) {
                historyBackBtn.addEventListener('click', () => {
                    showScreen('chat-list-screen');
                });
            }
            
            // 搜索按钮
            const searchBtn = document.getElementById('search-history-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', toggleHistorySearch);
            }
            
            // 清空历史按钮
            const clearBtn = document.getElementById('clear-history-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearChatHistory);
            }
            
            // 搜索输入框
            const searchInput = document.getElementById('history-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchHistory(e.target.value);
                });
            }
            
            // 取消搜索按钮
            const cancelSearchBtn = document.getElementById('cancel-search-btn');
            if (cancelSearchBtn) {
                cancelSearchBtn.addEventListener('click', toggleHistorySearch);
            }
            
            // 过滤标签
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchHistoryFilter(tab.dataset.filter);
                });
            });
            
            // 历史详情页面返回按钮
            const detailBackBtn = document.getElementById('history-detail-back-btn');
            if (detailBackBtn) {
                detailBackBtn.addEventListener('click', () => {
                    showScreen('call-history-screen');
                });
            }
            
            // 导出按钮
            const exportBtn = document.getElementById('export-history-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    // 从当前详情页面获取chatId
                    const chatId = getCurrentDetailChatId();
                    exportChatHistory(chatId);
                });
            }
            
            // 删除历史按钮
            const deleteBtn = document.getElementById('delete-history-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    const chatId = getCurrentDetailChatId();
                    if (chatId) {
                        const chat = state.chats[chatId];
                        const confirmed = confirm(`确定要删除《${chat.name}》的聊天历史吗？此操作不可撤销。`);
                        
                        if (confirmed) {
                            chat.history = [];
                            chat.lastMessage = '';
                            chat.lastMessageTime = null;
                            
                            DataStorage.save(DataStorage.KEYS.CHATS, state.chats);
                            
                            showNotification('聊天历史已删除');
                            showScreen('call-history-screen');
                            renderChatHistoryList();
                            renderChatList();
                        }
                    }
                });
            }
        }
        
        /**
         * 获取当前详情页面的聊天ID（简化实现）
         * @returns {string|null} 聊天ID
         */
        function getCurrentDetailChatId() {
            // 这里应该从页面状态获取，简化实现
            const historyItems = document.querySelectorAll('.history-item');
            if (historyItems.length > 0) {
                return historyItems[0].dataset.chatId;
            }
            return null;
        }
        
        // ===================================================================
        // 本地数据存储管理
        // ===================================================================
        
        /**
         * 聊天数据存储结构设计
         */
        const ChatDataSchema = {
            // 聊天基本信息
            chat: {
                id: 'string',           // 唯一标识符
                name: 'string',         // 聊天名称
                type: 'string',         // 'single' | 'group'
                avatar: 'string',       // 头像URL
                description: 'string',  // 描述
                participants: 'array',  // 参与者列表
                settings: 'object',     // 聊天设置
                createdAt: 'number',    // 创建时间戳
                updatedAt: 'number',    // 更新时间戳
                lastMessageTime: 'number', // 最后消息时间
                unreadCount: 'number',  // 未读消息数
                isPinned: 'boolean',    // 是否置顶
                isMuted: 'boolean',     // 是否静音
                isArchived: 'boolean'   // 是否归档
            },
            
            // 消息结构
            message: {
                id: 'string',           // 消息ID
                chatId: 'string',       // 所属聊天ID
                content: 'string',      // 消息内容
                type: 'string',         // 'text' | 'image' | 'file' | 'system'
                sender: 'object',       // 发送者信息
                timestamp: 'number',    // 发送时间戳
                status: 'string',       // 'sending' | 'sent' | 'delivered' | 'read'
                replyTo: 'string',      // 回复的消息ID
                attachments: 'array',   // 附件列表
                metadata: 'object'      // 元数据
            },
            
            // 用户信息
            user: {
                id: 'string',           // 用户ID
                name: 'string',         // 用户名
                avatar: 'string',       // 头像URL
                status: 'string',       // 在线状态
                lastSeen: 'number',     // 最后在线时间
                profile: 'object'       // 用户资料
            }
        };
        
        /**
         * IndexedDB 数据库管理器
         */
        class IndexedDBManager {
            constructor() {
                this.dbName = 'ChatAppDB';
                this.version = 1;
                this.db = null;
                this.isSupported = this.checkSupport();
            }
            
            /**
             * 检查IndexedDB支持
             */
            checkSupport() {
                return 'indexedDB' in window;
            }
            
            /**
             * 初始化数据库
             */
            async init() {
                if (!this.isSupported) {
                    console.warn('IndexedDB不支持，将使用localStorage');
                    return false;
                }
                
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => {
                        console.error('IndexedDB打开失败:', request.error);
                        reject(request.error);
                    };
                    
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('IndexedDB初始化成功');
                        resolve(true);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // 创建聊天对象存储
                        if (!db.objectStoreNames.contains('chats')) {
                            const chatStore = db.createObjectStore('chats', { keyPath: 'id' });
                            chatStore.createIndex('type', 'type', { unique: false });
                            chatStore.createIndex('lastMessageTime', 'lastMessageTime', { unique: false });
                            chatStore.createIndex('isPinned', 'isPinned', { unique: false });
                        }
                        
                        // 创建消息对象存储
                        if (!db.objectStoreNames.contains('messages')) {
                            const messageStore = db.createObjectStore('messages', { keyPath: 'id' });
                            messageStore.createIndex('chatId', 'chatId', { unique: false });
                            messageStore.createIndex('timestamp', 'timestamp', { unique: false });
                            messageStore.createIndex('sender', 'sender.id', { unique: false });
                        }
                        
                        // 创建用户对象存储
                        if (!db.objectStoreNames.contains('users')) {
                            const userStore = db.createObjectStore('users', { keyPath: 'id' });
                            userStore.createIndex('name', 'name', { unique: false });
                        }
                        
                        // 创建设置对象存储
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                        
                        // 创建附件对象存储
                        if (!db.objectStoreNames.contains('attachments')) {
                            const attachmentStore = db.createObjectStore('attachments', { keyPath: 'id' });
                            attachmentStore.createIndex('messageId', 'messageId', { unique: false });
                            attachmentStore.createIndex('type', 'type', { unique: false });
                        }
                        
                        console.log('IndexedDB数据库结构创建完成');
                    };
                });
            }
            
            /**
             * 通用数据操作方法
             */
            async transaction(storeName, mode = 'readonly') {
                if (!this.db) {
                    throw new Error('数据库未初始化');
                }
                return this.db.transaction([storeName], mode).objectStore(storeName);
            }
            
            /**
             * 添加或更新数据
             */
            async put(storeName, data) {
                try {
                    const store = await this.transaction(storeName, 'readwrite');
                    return new Promise((resolve, reject) => {
                        const request = store.put(data);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error(`数据保存失败 (${storeName}):`, error);
                    throw error;
                }
            }
            
            /**
             * 获取数据
             */
            async get(storeName, key) {
                try {
                    const store = await this.transaction(storeName, 'readonly');
                    return new Promise((resolve, reject) => {
                        const request = store.get(key);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error(`数据获取失败 (${storeName}):`, error);
                    throw error;
                }
            }
            
            /**
             * 获取所有数据
             */
            async getAll(storeName) {
                try {
                    const store = await this.transaction(storeName, 'readonly');
                    return new Promise((resolve, reject) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error(`数据获取失败 (${storeName}):`, error);
                    throw error;
                }
            }
            
            /**
             * 删除数据
             */
            async delete(storeName, key) {
                try {
                    const store = await this.transaction(storeName, 'readwrite');
                    return new Promise((resolve, reject) => {
                        const request = store.delete(key);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error(`数据删除失败 (${storeName}):`, error);
                    throw error;
                }
            }
            
            /**
             * 按索引查询数据
             */
            async getByIndex(storeName, indexName, value) {
                try {
                    const store = await this.transaction(storeName, 'readonly');
                    const index = store.index(indexName);
                    return new Promise((resolve, reject) => {
                        const request = index.getAll(value);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error(`索引查询失败 (${storeName}.${indexName}):`, error);
                    throw error;
                }
            }
            
            /**
             * 清空对象存储
             */
            async clear(storeName) {
                try {
                    const store = await this.transaction(storeName, 'readwrite');
                    return new Promise((resolve, reject) => {
                        const request = store.clear();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error(`数据清空失败 (${storeName}):`, error);
                    throw error;
                }
            }
        }
        
        /**
         * 增强的数据存储管理器
         */
        const DataStorage = {
            // 存储键名常量
            KEYS: {
                CHATS: 'chats',
                MESSAGES: 'messages',
                USERS: 'users',
                API_SETTINGS: 'apiSettings',
                APPEARANCE_SETTINGS: 'appearanceSettings',
                FONT_SETTINGS: 'fontSettings',
                QZONE_SETTINGS: 'qzoneSettings',
                QZONE_POSTS: 'qzonePosts',
                WORLD_BOOKS: 'worldBooks',
                USER_PREFERENCES: 'userPreferences',
                APP_STATE: 'appState',
                ATTACHMENTS: 'attachments'
            },
            
            // IndexedDB管理器实例
            idbManager: new IndexedDBManager(),
            
            // 是否使用IndexedDB
            useIndexedDB: false,
            
            /**
             * 初始化存储系统
             */
            async init() {
                try {
                    this.useIndexedDB = await this.idbManager.init();
                    console.log(`存储系统初始化完成，使用: ${this.useIndexedDB ? 'IndexedDB' : 'localStorage'}`);
                    return true;
                } catch (error) {
                    console.error('存储系统初始化失败:', error);
                    this.useIndexedDB = false;
                    return false;
                }
            },
            
            /**
             * 保存数据 - 统一接口
             * @param {string} key - 存储键
             * @param {any} data - 要保存的数据
             * @param {Object} options - 保存选项
             * @returns {boolean} 是否保存成功
             */
            async save(key, data, options = {}) {
                try {
                    // 添加时间戳和版本信息
                    const enhancedData = {
                        ...data,
                        _metadata: {
                            savedAt: Date.now(),
                            version: options.version || '1.0',
                            key: key
                        }
                    };
                    
                    if (this.useIndexedDB && this.isIndexedDBKey(key)) {
                        await this.saveToIndexedDB(key, enhancedData);
                    } else {
                        await this.saveToLocalStorage(key, enhancedData);
                    }
                    
                    console.log(`数据保存成功: ${key}`);
                    return true;
                } catch (error) {
                    console.error(`数据保存失败: ${key}`, error);
                    this.handleStorageError(error, key);
                    return false;
                }
            },
            
            /**
             * 保存到localStorage
             */
            async saveToLocalStorage(key, data) {
                const jsonData = JSON.stringify(data);
                localStorage.setItem(key, jsonData);
            },
            
            /**
             * 保存到IndexedDB
             */
            async saveToIndexedDB(key, data) {
                const storeName = this.getStoreNameForKey(key);
                if (Array.isArray(data)) {
                    // 批量保存
                    for (const item of data) {
                        await this.idbManager.put(storeName, item);
                    }
                } else {
                    await this.idbManager.put(storeName, data);
                }
            },
            
            /**
             * 判断是否为IndexedDB键
             */
            isIndexedDBKey(key) {
                return [
                    this.KEYS.CHATS,
                    this.KEYS.MESSAGES,
                    this.KEYS.USERS,
                    this.KEYS.ATTACHMENTS
                ].includes(key);
            },
            
            /**
             * 获取键对应的存储名称
             */
            getStoreNameForKey(key) {
                const storeMap = {
                    [this.KEYS.CHATS]: 'chats',
                    [this.KEYS.MESSAGES]: 'messages',
                    [this.KEYS.USERS]: 'users',
                    [this.KEYS.ATTACHMENTS]: 'attachments'
                };
                return storeMap[key] || 'settings';
            },
            
            /**
             * 加载数据 - 统一接口
             * @param {string} key - 存储键
             * @param {any} defaultValue - 默认值
             * @param {Object} options - 加载选项
             * @returns {any} 加载的数据或默认值
             */
            async load(key, defaultValue = null, options = {}) {
                try {
                    let data;
                    
                    if (this.useIndexedDB && this.isIndexedDBKey(key)) {
                        data = await this.loadFromIndexedDB(key, options);
                    } else {
                        data = await this.loadFromLocalStorage(key);
                    }
                    
                    if (data === null || data === undefined) {
                        return defaultValue;
                    }
                    
                    // 移除元数据（如果存在）
                    if (data && data._metadata) {
                        const { _metadata, ...cleanData } = data;
                        data = cleanData;
                    }
                    
                    console.log(`数据加载成功: ${key}`);
                    return data;
                } catch (error) {
                    console.error(`数据加载失败: ${key}`, error);
                    this.handleStorageError(error, key);
                    return defaultValue;
                }
            },
            
            /**
             * 从localStorage加载
             */
            async loadFromLocalStorage(key) {
                const jsonData = localStorage.getItem(key);
                if (jsonData === null) {
                    return null;
                }
                return JSON.parse(jsonData);
            },
            
            /**
             * 从IndexedDB加载
             */
            async loadFromIndexedDB(key, options = {}) {
                const storeName = this.getStoreNameForKey(key);
                
                if (options.id) {
                    // 加载单个项目
                    return await this.idbManager.get(storeName, options.id);
                } else if (options.filter) {
                    // 按条件过滤
                    const allData = await this.idbManager.getAll(storeName);
                    return allData.filter(options.filter);
                } else {
                    // 加载所有数据
                    return await this.idbManager.getAll(storeName);
                }
            },
            
            /**
             * 高级查询方法
             */
            async query(key, options = {}) {
                try {
                    if (!this.useIndexedDB || !this.isIndexedDBKey(key)) {
                        // 对于localStorage，使用基本的load方法
                        const data = await this.load(key);
                        if (options.filter && Array.isArray(data)) {
                            return data.filter(options.filter);
                        }
                        return data;
                    }
                    
                    const storeName = this.getStoreNameForKey(key);
                    
                    if (options.index && options.value) {
                        // 使用索引查询
                        return await this.idbManager.getByIndex(storeName, options.index, options.value);
                    } else if (options.filter) {
                        // 过滤查询
                        const allData = await this.idbManager.getAll(storeName);
                        return allData.filter(options.filter);
                    } else if (options.sort) {
                        // 排序查询
                        const allData = await this.idbManager.getAll(storeName);
                        return allData.sort(options.sort);
                    } else {
                        // 普通查询
                        return await this.idbManager.getAll(storeName);
                    }
                } catch (error) {
                    console.error(`查询失败: ${key}`, error);
                    return [];
                }
            },
            
            /**
             * 添加单个项目
             */
            async add(key, item) {
                try {
                    if (this.useIndexedDB && this.isIndexedDBKey(key)) {
                        const storeName = this.getStoreNameForKey(key);
                        
                        // 确保有ID
                        if (!item.id) {
                            item.id = this.generateId();
                        }
                        
                        // 添加时间戳
                        item.createdAt = item.createdAt || Date.now();
                        item.updatedAt = Date.now();
                        
                        await this.idbManager.put(storeName, item);
                    } else {
                        // localStorage处理
                        const existingData = await this.load(key, []);
                        const dataArray = Array.isArray(existingData) ? existingData : [];
                        
                        if (!item.id) {
                            item.id = this.generateId();
                        }
                        
                        item.createdAt = item.createdAt || Date.now();
                        item.updatedAt = Date.now();
                        
                        dataArray.push(item);
                        await this.save(key, dataArray);
                    }
                    
                    console.log(`项目添加成功: ${key}/${item.id}`);
                    return item;
                } catch (error) {
                    console.error(`项目添加失败: ${key}`, error);
                    throw error;
                }
            },
            
            /**
             * 更新单个项目
             */
            async update(key, id, updates) {
                try {
                    if (this.useIndexedDB && this.isIndexedDBKey(key)) {
                        const storeName = this.getStoreNameForKey(key);
                        const existing = await this.idbManager.get(storeName, id);
                        
                        if (!existing) {
                            throw new Error(`项目不存在: ${id}`);
                        }
                        
                        const updated = {
                            ...existing,
                            ...updates,
                            id: id, // 确保ID不被覆盖
                            updatedAt: Date.now()
                        };
                        
                        await this.idbManager.put(storeName, updated);
                        return updated;
                    } else {
                        // localStorage处理
                        const existingData = await this.load(key, []);
                        const dataArray = Array.isArray(existingData) ? existingData : [];
                        
                        const index = dataArray.findIndex(item => item.id === id);
                        if (index === -1) {
                            throw new Error(`项目不存在: ${id}`);
                        }
                        
                        dataArray[index] = {
                            ...dataArray[index],
                            ...updates,
                            id: id,
                            updatedAt: Date.now()
                        };
                        
                        await this.save(key, dataArray);
                        return dataArray[index];
                    }
                } catch (error) {
                    console.error(`项目更新失败: ${key}/${id}`, error);
                    throw error;
                }
            },
            
            /**
             * 删除单个项目
             */
            async deleteItem(key, id) {
                try {
                    if (this.useIndexedDB && this.isIndexedDBKey(key)) {
                        const storeName = this.getStoreNameForKey(key);
                        await this.idbManager.delete(storeName, id);
                    } else {
                        // localStorage处理
                        const existingData = await this.load(key, []);
                        const dataArray = Array.isArray(existingData) ? existingData : [];
                        
                        const filteredData = dataArray.filter(item => item.id !== id);
                        await this.save(key, filteredData);
                    }
                    
                    console.log(`项目删除成功: ${key}/${id}`);
                    return true;
                } catch (error) {
                    console.error(`项目删除失败: ${key}/${id}`, error);
                    return false;
                }
            },
            
            /**
             * 删除存储的数据
             * @param {string} key - 存储键
             * @returns {boolean} 是否删除成功
             */
            async remove(key) {
                try {
                    if (this.useIndexedDB && this.isIndexedDBKey(key)) {
                        const storeName = this.getStoreNameForKey(key);
                        await this.idbManager.clear(storeName);
                    } else {
                        localStorage.removeItem(key);
                    }
                    console.log(`数据删除成功: ${key}`);
                    return true;
                } catch (error) {
                    console.error(`数据删除失败: ${key}`, error);
                    return false;
                }
            },
            
            /**
             * 生成唯一ID
             */
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            
            /**
             * 清空所有存储数据
             * @returns {boolean} 是否清空成功
             */
            clear() {
                try {
                    localStorage.clear();
                    console.log('所有数据已清空');
                    return true;
                } catch (error) {
                    console.error('数据清空失败', error);
                    return false;
                }
            },
            
            /**
             * 获取存储使用情况
             * @returns {Object} 存储使用情况信息
             */
            getStorageInfo() {
                let totalSize = 0;
                let itemCount = 0;
                const items = {};
                
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        const value = localStorage.getItem(key);
                        const size = new Blob([value]).size;
                        items[key] = {
                            size: size,
                            sizeFormatted: this.formatBytes(size)
                        };
                        totalSize += size;
                        itemCount++;
                    }
                }
                
                return {
                    totalSize: totalSize,
                    totalSizeFormatted: this.formatBytes(totalSize),
                    itemCount: itemCount,
                    items: items,
                    available: this.getAvailableStorage()
                };
            },
            
            /**
             * 格式化字节大小
             * @param {number} bytes - 字节数
             * @returns {string} 格式化后的大小
             */
            formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            
            /**
             * 获取可用存储空间
             * @returns {number} 可用空间（估算）
             */
            getAvailableStorage() {
                try {
                    // 尝试存储测试数据来估算可用空间
                    const testKey = '__storage_test__';
                    let testSize = 1024 * 1024; // 1MB
                    let available = 0;
                    
                    while (testSize > 0) {
                        try {
                            const testData = 'x'.repeat(testSize);
                            localStorage.setItem(testKey, testData);
                            localStorage.removeItem(testKey);
                            available = testSize;
                            break;
                        } catch (e) {
                            testSize = Math.floor(testSize / 2);
                        }
                    }
                    
                    return available;
                } catch (error) {
                    return 0;
                }
            },
            
            /**
             * 处理存储错误
             * @param {Error} error - 错误对象
             * @param {string} key - 相关的存储键
             */
            handleStorageError(error, key) {
                if (error.name === 'QuotaExceededError') {
                    console.warn('存储空间不足，尝试清理旧数据');
                    this.cleanupOldData();
                    showNotification('存储空间不足，已清理部分旧数据');
                } else {
                    console.error('存储操作失败:', error);
                    showNotification('数据存储失败，请检查浏览器设置');
                }
            },
            
            /**
             * 清理旧数据
             */
            cleanupOldData() {
                try {
                    // 清理超过30天的聊天记录
                    const chats = this.load(this.KEYS.CHATS, {});
                    const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
                    
                    Object.values(chats).forEach(chat => {
                        if (chat.history) {
                            chat.history = chat.history.filter(message => 
                                message.timestamp > thirtyDaysAgo
                            );
                        }
                    });
                    
                    this.save(this.KEYS.CHATS, chats);
                    
                    // 清理旧的动态
                    const posts = this.load(this.KEYS.QZONE_POSTS, []);
                    const recentPosts = posts.filter(post => 
                        post.timestamp > thirtyDaysAgo
                    );
                    this.save(this.KEYS.QZONE_POSTS, recentPosts);
                    
                    console.log('旧数据清理完成');
                } catch (error) {
                    console.error('数据清理失败:', error);
                }
            },
            
            /**
             * 备份所有数据
             * @param {Object} options - 备份选项
             * @returns {Object} 备份数据对象
             */
            async backup(options = {}) {
                const backupData = {
                    timestamp: Date.now(),
                    version: '2.0',
                    storageType: this.useIndexedDB ? 'IndexedDB' : 'localStorage',
                    data: {},
                    metadata: {
                        userAgent: navigator.userAgent,
                        url: window.location.href,
                        backupSize: 0
                    }
                };
                
                try {
                    // 备份所有关键数据
                    for (const key of Object.values(this.KEYS)) {
                        try {
                            const data = await this.load(key);
                            if (data !== null && data !== undefined) {
                                backupData.data[key] = data;
                            }
                        } catch (error) {
                            console.warn(`备份数据失败: ${key}`, error);
                            if (!options.ignoreErrors) {
                                throw error;
                            }
                        }
                    }
                    
                    // 计算备份大小
                    const backupString = JSON.stringify(backupData);
                    backupData.metadata.backupSize = new Blob([backupString]).size;
                    
                    console.log('数据备份完成', {
                        size: this.formatBytes(backupData.metadata.backupSize),
                        items: Object.keys(backupData.data).length
                    });
                    
                    return backupData;
                } catch (error) {
                    console.error('数据备份失败:', error);
                    throw error;
                }
            },
            
            /**
             * 增量备份
             * @param {number} since - 备份指定时间之后的数据
             */
            async incrementalBackup(since) {
                const backupData = {
                    timestamp: Date.now(),
                    version: '2.0',
                    type: 'incremental',
                    since: since,
                    data: {}
                };
                
                try {
                    // 只备份修改过的数据
                    if (this.useIndexedDB) {
                        // IndexedDB增量备份
                        for (const key of [this.KEYS.CHATS, this.KEYS.MESSAGES]) {
                            const data = await this.query(key, {
                                filter: item => item.updatedAt > since
                            });
                            if (data && data.length > 0) {
                                backupData.data[key] = data;
                            }
                        }
                    } else {
                        // localStorage增量备份（简化版）
                        for (const key of Object.values(this.KEYS)) {
                            const data = await this.load(key);
                            if (data && data._metadata && data._metadata.savedAt > since) {
                                backupData.data[key] = data;
                            }
                        }
                    }
                    
                    return backupData;
                } catch (error) {
                    console.error('增量备份失败:', error);
                    throw error;
                }
            },
            
            /**
             * 从备份恢复数据
             * @param {Object} backupData - 备份数据对象
             * @param {Object} options - 恢复选项
             * @returns {boolean} 是否恢复成功
             */
            async restore(backupData, options = {}) {
                try {
                    if (!backupData || !backupData.data) {
                        throw new Error('无效的备份数据');
                    }
                    
                    // 验证备份版本兼容性
                    if (backupData.version && !this.isVersionCompatible(backupData.version)) {
                        console.warn('备份版本可能不兼容:', backupData.version);
                        if (!options.forceRestore) {
                            throw new Error('备份版本不兼容，请使用forceRestore选项强制恢复');
                        }
                    }
                    
                    // 创建恢复前的备份
                    if (options.createBackupBeforeRestore) {
                        const preRestoreBackup = await this.backup();
                        await this.save('preRestoreBackup', preRestoreBackup);
                    }
                    
                    let restoredCount = 0;
                    let failedCount = 0;
                    
                    // 恢复所有数据
                    for (const [key, value] of Object.entries(backupData.data)) {
                        try {
                            if (backupData.type === 'incremental') {
                                // 增量恢复 - 合并数据
                                await this.mergeData(key, value);
                            } else {
                                // 完整恢复 - 替换数据
                                await this.save(key, value);
                            }
                            restoredCount++;
                        } catch (error) {
                            console.error(`恢复数据失败: ${key}`, error);
                            failedCount++;
                            if (!options.continueOnError) {
                                throw error;
                            }
                        }
                    }
                    
                    console.log('数据恢复完成', {
                        restored: restoredCount,
                        failed: failedCount,
                        total: Object.keys(backupData.data).length
                    });
                    
                    return failedCount === 0;
                } catch (error) {
                    console.error('数据恢复失败:', error);
                    return false;
                }
            },
            
            /**
             * 合并数据（用于增量恢复）
             */
            async mergeData(key, newData) {
                if (!Array.isArray(newData)) {
                    // 非数组数据直接保存
                    await this.save(key, newData);
                    return;
                }
                
                const existingData = await this.load(key, []);
                const existingArray = Array.isArray(existingData) ? existingData : [];
                
                // 合并数组数据
                const mergedData = [...existingArray];
                
                for (const newItem of newData) {
                    const existingIndex = mergedData.findIndex(item => item.id === newItem.id);
                    if (existingIndex >= 0) {
                        // 更新现有项目
                        mergedData[existingIndex] = newItem;
                    } else {
                        // 添加新项目
                        mergedData.push(newItem);
                    }
                }
                
                await this.save(key, mergedData);
            },
            
            /**
             * 检查版本兼容性
             */
            isVersionCompatible(version) {
                const currentVersion = '2.0';
                const supportedVersions = ['1.0', '2.0'];
                return supportedVersions.includes(version);
            },
            
            /**
             * 导出数据到文件
             * @param {Object} options - 导出选项
             */
            async exportToFile(options = {}) {
                try {
                    const backupData = await this.backup(options);
                    
                    // 选择导出格式
                    const format = options.format || 'json';
                    let blob, filename;
                    
                    switch (format) {
                        case 'json':
                            blob = new Blob([JSON.stringify(backupData, null, 2)], { 
                                type: 'application/json' 
                            });
                            filename = `chat_app_backup_${new Date().toISOString().split('T')[0]}.json`;
                            break;
                            
                        case 'csv':
                            const csvData = this.convertToCSV(backupData);
                            blob = new Blob([csvData], { type: 'text/csv' });
                            filename = `chat_app_backup_${new Date().toISOString().split('T')[0]}.csv`;
                            break;
                            
                        default:
                            throw new Error('不支持的导出格式');
                    }
                    
                    // 下载文件
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification(`数据导出成功 (${this.formatBytes(blob.size)})`);
                    console.log('数据导出完成', { format, size: blob.size });
                } catch (error) {
                    console.error('数据导出失败:', error);
                    showNotification('数据导出失败: ' + error.message);
                }
            },
            
            /**
             * 转换为CSV格式
             */
            convertToCSV(backupData) {
                const csvRows = [];
                
                // 添加头部信息
                csvRows.push('数据类型,ID,名称,内容,时间戳');
                
                // 处理聊天数据
                if (backupData.data.chats) {
                    const chats = Array.isArray(backupData.data.chats) ? backupData.data.chats : Object.values(backupData.data.chats);
                    chats.forEach(chat => {
                        csvRows.push(`聊天,${chat.id},"${chat.name}","${chat.description || ''}",${chat.createdAt || ''}`);
                    });
                }
                
                // 处理消息数据
                if (backupData.data.messages) {
                    const messages = Array.isArray(backupData.data.messages) ? backupData.data.messages : [];
                    messages.forEach(message => {
                        csvRows.push(`消息,${message.id},"${message.sender?.name || ''}","${message.content}",${message.timestamp}`);
                    });
                }
                
                return csvRows.join('\n');
            },
            
            /**
             * 导出特定数据类型
             */
            async exportSpecificData(dataType, options = {}) {
                try {
                    const data = await this.load(dataType);
                    if (!data) {
                        throw new Error('没有找到要导出的数据');
                    }
                    
                    const exportData = {
                        timestamp: Date.now(),
                        dataType: dataType,
                        data: data
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                        type: 'application/json' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${dataType}_${new Date().toISOString().split('T')[0]}.json`;
                    a.style.display = 'none';
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification(`${dataType} 数据导出成功`);
                } catch (error) {
                    console.error(`${dataType} 数据导出失败:`, error);
                    showNotification(`${dataType} 数据导出失败`);
                }
            },
            
            /**
             * 从文件导入数据
             * @param {Object} options - 导入选项
             */
            async importFromFile(options = {}) {
                return new Promise((resolve) => {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json,.csv';
                    fileInput.style.display = 'none';
                    fileInput.multiple = options.multiple || false;
                    
                    fileInput.addEventListener('change', async (e) => {
                        const files = Array.from(e.target.files);
                        let successCount = 0;
                        let failCount = 0;
                        
                        for (const file of files) {
                            try {
                                const result = await this.processImportFile(file, options);
                                if (result) {
                                    successCount++;
                                } else {
                                    failCount++;
                                }
                            } catch (error) {
                                console.error('文件处理失败:', error);
                                failCount++;
                            }
                        }
                        
                        document.body.removeChild(fileInput);
                        
                        if (successCount > 0) {
                            showNotification(`成功导入 ${successCount} 个文件${failCount > 0 ? `，失败 ${failCount} 个` : ''}`);
                            
                            if (options.autoReload !== false) {
                                setTimeout(() => {
                                    if (confirm('数据导入成功！是否刷新页面以应用更改？')) {
                                        location.reload();
                                    }
                                }, 1000);
                            }
                        } else {
                            showNotification('数据导入失败');
                        }
                        
                        resolve({ success: successCount, failed: failCount });
                    });
                    
                    document.body.appendChild(fileInput);
                    fileInput.click();
                });
            },
            
            /**
             * 处理导入文件
             */
            async processImportFile(file, options = {}) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        try {
                            let data;
                            
                            if (file.name.endsWith('.json')) {
                                data = JSON.parse(e.target.result);
                            } else if (file.name.endsWith('.csv')) {
                                data = this.parseCSV(e.target.result);
                            } else {
                                throw new Error('不支持的文件格式');
                            }
                            
                            // 验证数据格式
                            if (!this.validateImportData(data)) {
                                throw new Error('数据格式验证失败');
                            }
                            
                            // 执行导入
                            const restoreOptions = {
                                createBackupBeforeRestore: options.createBackup !== false,
                                continueOnError: options.continueOnError === true,
                                forceRestore: options.forceRestore === true
                            };
                            
                            const success = await this.restore(data, restoreOptions);
                            resolve(success);
                        } catch (error) {
                            console.error('数据解析失败:', error);
                            showNotification(`文件 ${file.name} 格式错误: ${error.message}`);
                            resolve(false);
                        }
                    };
                    
                    reader.onerror = () => {
                        console.error('文件读取失败');
                        resolve(false);
                    };
                    
                    reader.readAsText(file);
                });
            },
            
            /**
             * 解析CSV数据
             */
            parseCSV(csvText) {
                // 简化的CSV解析实现
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                const data = { data: { messages: [] } };
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length >= headers.length && values[0] === '消息') {
                        data.data.messages.push({
                            id: values[1],
                            sender: { name: values[2].replace(/"/g, '') },
                            content: values[3].replace(/"/g, ''),
                            timestamp: parseInt(values[4]) || Date.now()
                        });
                    }
                }
                
                return data;
            },
            
            /**
             * 验证导入数据
             */
            validateImportData(data) {
                if (!data || typeof data !== 'object') {
                    return false;
                }
                
                // 检查是否有data字段或者是特定数据类型
                if (data.data || data.dataType) {
                    return true;
                }
                
                // 检查是否是旧版本格式
                if (data.timestamp && data.version) {
                    return true;
                }
                
                return false;
            },
            
            /**
             * 批量导入数据
             */
            async batchImport(dataArray, options = {}) {
                let successCount = 0;
                let failCount = 0;
                
                for (const data of dataArray) {
                    try {
                        const success = await this.restore(data, options);
                        if (success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        console.error('批量导入项目失败:', error);
                        failCount++;
                        if (!options.continueOnError) {
                            break;
                        }
                    }
                }
                
                return { success: successCount, failed: failCount };
            }
        };
        
        /**
         * 聊天数据管理器 - 专门处理聊天相关的数据操作
         */
        const ChatDataManager = {
            /**
             * 创建新聊天
             */
            async createChat(chatData) {
                const chat = {
                    id: DataStorage.generateId(),
                    name: chatData.name,
                    type: chatData.type || 'single',
                    avatar: chatData.avatar || '',
                    description: chatData.description || '',
                    participants: chatData.participants || [],
                    settings: chatData.settings || {},
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    lastMessageTime: null,
                    unreadCount: 0,
                    isPinned: false,
                    isMuted: false,
                    isArchived: false,
                    ...chatData
                };
                
                return await DataStorage.add(DataStorage.KEYS.CHATS, chat);
            },
            
            /**
             * 获取聊天列表
             */
            async getChatList(options = {}) {
                const chats = await DataStorage.query(DataStorage.KEYS.CHATS, {
                    sort: (a, b) => {
                        // 置顶聊天优先
                        if (a.isPinned && !b.isPinned) return -1;
                        if (!a.isPinned && b.isPinned) return 1;
                        
                        // 按最后消息时间排序
                        return (b.lastMessageTime || 0) - (a.lastMessageTime || 0);
                    },
                    filter: options.filter
                });
                
                return Array.isArray(chats) ? chats : Object.values(chats);
            },
            
            /**
             * 添加消息
             */
            async addMessage(chatId, messageData) {
                const message = {
                    id: DataStorage.generateId(),
                    chatId: chatId,
                    content: messageData.content,
                    type: messageData.type || 'text',
                    sender: messageData.sender,
                    timestamp: Date.now(),
                    status: 'sent',
                    replyTo: messageData.replyTo || null,
                    attachments: messageData.attachments || [],
                    metadata: messageData.metadata || {},
                    ...messageData
                };
                
                // 保存消息
                await DataStorage.add(DataStorage.KEYS.MESSAGES, message);
                
                // 更新聊天的最后消息时间
                await DataStorage.update(DataStorage.KEYS.CHATS, chatId, {
                    lastMessageTime: message.timestamp,
                    updatedAt: Date.now()
                });
                
                return message;
            },
            
            /**
             * 获取聊天消息
             */
            async getChatMessages(chatId, options = {}) {
                const messages = await DataStorage.query(DataStorage.KEYS.MESSAGES, {
                    filter: message => message.chatId === chatId,
                    sort: (a, b) => a.timestamp - b.timestamp
                });
                
                if (options.limit) {
                    return messages.slice(-options.limit);
                }
                
                return messages;
            },
            
            /**
             * 删除聊天
             */
            async deleteChat(chatId) {
                // 删除聊天记录
                await DataStorage.deleteItem(DataStorage.KEYS.CHATS, chatId);
                
                // 删除相关消息
                const messages = await this.getChatMessages(chatId);
                for (const message of messages) {
                    await DataStorage.deleteItem(DataStorage.KEYS.MESSAGES, message.id);
                }
                
                return true;
            },
            
            /**
             * 清空聊天历史
             */
            async clearChatHistory(chatId) {
                const messages = await this.getChatMessages(chatId);
                for (const message of messages) {
                    await DataStorage.deleteItem(DataStorage.KEYS.MESSAGES, message.id);
                }
                
                // 重置聊天的最后消息时间
                await DataStorage.update(DataStorage.KEYS.CHATS, chatId, {
                    lastMessageTime: null,
                    unreadCount: 0,
                    updatedAt: Date.now()
                });
                
                return true;
            }
        };
        
        /**
         * 数据同步管理器
         */
        const DataSync = {
            /**
             * 自动保存聊天数据
             */
            async autoSaveChats() {
                await DataStorage.save(DataStorage.KEYS.CHATS, state.chats);
            },
            
            /**
             * 自动保存API设置
             */
            async autoSaveAPISettings() {
                await DataStorage.save(DataStorage.KEYS.API_SETTINGS, state.globalSettings.apiSettings);
            },
            
            /**
             * 自动保存外观设置
             */
            async autoSaveAppearanceSettings() {
                await DataStorage.save(DataStorage.KEYS.APPEARANCE_SETTINGS, state.globalSettings.appearanceSettings);
            },
            
            /**
             * 自动保存字体设置
             */
            async autoSaveFontSettings() {
                await DataStorage.save(DataStorage.KEYS.FONT_SETTINGS, state.globalSettings.fontSettings);
            },
            
            /**
             * 自动保存动态设置
             */
            async autoSaveQzoneSettings() {
                await DataStorage.save(DataStorage.KEYS.QZONE_SETTINGS, state.globalSettings.qzoneSettings);
            },
            
            /**
             * 自动保存动态数据
             */
            async autoSaveQzonePosts() {
                await DataStorage.save(DataStorage.KEYS.QZONE_POSTS, state.qzonePosts);
            },
            
            /**
             * 自动保存世界书数据
             */
            async autoSaveWorldBooks() {
                await DataStorage.save(DataStorage.KEYS.WORLD_BOOKS, state.worldBooks);
            },
            
            /**
             * 保存所有数据
             */
            async saveAll() {
                try {
                    await Promise.all([
                        this.autoSaveChats(),
                        this.autoSaveAPISettings(),
                        this.autoSaveAppearanceSettings(),
                        this.autoSaveFontSettings(),
                        this.autoSaveQzoneSettings(),
                        this.autoSaveQzonePosts(),
                        this.autoSaveWorldBooks()
                    ]);
                    console.log('所有数据自动保存完成');
                } catch (error) {
                    console.error('自动保存失败:', error);
                }
            },
            
            /**
             * 定期自动保存
             */
            startAutoSave() {
                // 每30秒自动保存一次
                setInterval(async () => {
                    await this.saveAll();
                }, 30000);
                
                // 页面卸载时保存
                window.addEventListener('beforeunload', async () => {
                    await this.saveAll();
                });
                
                // 页面隐藏时保存
                document.addEventListener('visibilitychange', async () => {
                    if (document.hidden) {
                        await this.saveAll();
                    }
                });
            }
        };
        
        /**
         * 数据管理工具函数
         */
        const DataUtils = {
            /**
             * 数据验证
             */
            validateChatData(chat) {
                return chat && 
                       typeof chat.id === 'string' && 
                       typeof chat.name === 'string' && 
                       ['single', 'group'].includes(chat.type);
            },
            
            validateMessageData(message) {
                return message && 
                       typeof message.id === 'string' && 
                       typeof message.chatId === 'string' && 
                       typeof message.content === 'string' && 
                       typeof message.timestamp === 'number';
            },
            
            /**
             * 数据清理
             */
            async cleanupOldMessages(daysToKeep = 30) {
                const cutoffTime = Date.now() - (daysToKeep * 24 * 60 * 60 * 1000);
                const allMessages = await DataStorage.query(DataStorage.KEYS.MESSAGES);
                
                let deletedCount = 0;
                for (const message of allMessages) {
                    if (message.timestamp < cutoffTime) {
                        await DataStorage.deleteItem(DataStorage.KEYS.MESSAGES, message.id);
                        deletedCount++;
                    }
                }
                
                console.log(`清理了 ${deletedCount} 条旧消息`);
                return deletedCount;
            },
            
            /**
             * 数据统计
             */
            async getStorageStats() {
                const stats = {
                    chats: 0,
                    messages: 0,
                    totalSize: 0,
                    oldestMessage: null,
                    newestMessage: null
                };
                
                try {
                    const chats = await DataStorage.query(DataStorage.KEYS.CHATS);
                    const messages = await DataStorage.query(DataStorage.KEYS.MESSAGES);
                    
                    stats.chats = Array.isArray(chats) ? chats.length : Object.keys(chats).length;
                    stats.messages = Array.isArray(messages) ? messages.length : 0;
                    
                    if (Array.isArray(messages) && messages.length > 0) {
                        const sortedMessages = messages.sort((a, b) => a.timestamp - b.timestamp);
                        stats.oldestMessage = sortedMessages[0];
                        stats.newestMessage = sortedMessages[sortedMessages.length - 1];
                    }
                    
                    // 计算存储大小
                    const storageInfo = DataStorage.getStorageInfo();
                    stats.totalSize = storageInfo.totalSize;
                    stats.formattedSize = storageInfo.totalSizeFormatted;
                    
                } catch (error) {
                    console.error('获取存储统计失败:', error);
                }
                
                return stats;
            },
            
            /**
             * 数据完整性检查
             */
            async checkDataIntegrity() {
                const issues = [];
                
                try {
                    // 检查聊天数据
                    const chats = await DataStorage.query(DataStorage.KEYS.CHATS);
                    const chatArray = Array.isArray(chats) ? chats : Object.values(chats);
                    
                    for (const chat of chatArray) {
                        if (!this.validateChatData(chat)) {
                            issues.push(`无效的聊天数据: ${chat.id || '未知ID'}`);
                        }
                    }
                    
                    // 检查消息数据
                    const messages = await DataStorage.query(DataStorage.KEYS.MESSAGES);
                    if (Array.isArray(messages)) {
                        for (const message of messages) {
                            if (!this.validateMessageData(message)) {
                                issues.push(`无效的消息数据: ${message.id || '未知ID'}`);
                            }
                            
                            // 检查消息是否有对应的聊天
                            const chatExists = chatArray.some(chat => chat.id === message.chatId);
                            if (!chatExists) {
                                issues.push(`孤立的消息: ${message.id} (聊天ID: ${message.chatId})`);
                            }
                        }
                    }
                    
                } catch (error) {
                    issues.push(`数据完整性检查失败: ${error.message}`);
                }
                
                return issues;
            },
            
            /**
             * 修复数据问题
             */
            async repairData() {
                const issues = await this.checkDataIntegrity();
                let repairedCount = 0;
                
                for (const issue of issues) {
                    try {
                        if (issue.includes('孤立的消息')) {
                            // 删除孤立的消息
                            const messageId = issue.match(/消息: (\w+)/)?.[1];
                            if (messageId) {
                                await DataStorage.deleteItem(DataStorage.KEYS.MESSAGES, messageId);
                                repairedCount++;
                            }
                        }
                    } catch (error) {
                        console.error('修复数据失败:', error);
                    }
                }
                
                console.log(`修复了 ${repairedCount} 个数据问题`);
                return repairedCount;
            }
        };
        
        /**
         * 更新所有保存函数以使用新的存储管理器
         */
        function updateStorageFunctions() {
            // 重写现有的保存函数
            const originalLocalStorageSetItem = localStorage.setItem;
            const originalLocalStorageGetItem = localStorage.getItem;
            
            // 监听存储变化
            window.addEventListener('storage', (e) => {
                console.log('存储变化检测:', e.key, e.newValue);
                // 可以在这里处理跨标签页的数据同步
            });
            
            // 页面卸载时保存数据
            window.addEventListener('beforeunload', () => {
                DataSync.autoSaveChats();
                DataSync.autoSaveQzonePosts();
                DataSync.autoSaveWorldBooks();
                console.log('页面卸载前保存数据完成');
            });
        }
        
        /**
         * 初始化数据存储系统
         */
        async function initializeDataStorage() {
            console.log('初始化数据存储系统');
            
            // 检查存储可用性
            if (typeof(Storage) === "undefined") {
                console.error('浏览器不支持本地存储');
                showNotification('浏览器不支持本地存储功能');
                return;
            }
            
            try {
                // 初始化存储系统
                await DataStorage.init();
                
                // 加载所有数据到全局状态
                state.chats = await DataStorage.load(DataStorage.KEYS.CHATS, {});
                state.globalSettings.apiSettings = await DataStorage.load(DataStorage.KEYS.API_SETTINGS, {});
                state.globalSettings.appearanceSettings = await DataStorage.load(DataStorage.KEYS.APPEARANCE_SETTINGS, {});
                state.globalSettings.fontSettings = await DataStorage.load(DataStorage.KEYS.FONT_SETTINGS, {});
                state.globalSettings.qzoneSettings = await DataStorage.load(DataStorage.KEYS.QZONE_SETTINGS, {});
                state.qzonePosts = await DataStorage.load(DataStorage.KEYS.QZONE_POSTS, []);
                state.worldBooks = await DataStorage.load(DataStorage.KEYS.WORLD_BOOKS, []);
                
                // 显示存储信息
                const storageInfo = DataStorage.getStorageInfo();
                console.log('存储使用情况:', storageInfo);
                
                // 更新存储函数
                updateStorageFunctions();
                
                // 启动自动保存
                DataSync.startAutoSave();
                
                // 设置数据迁移（如果需要）
                await performDataMigration();
                
                console.log('数据存储系统初始化完成');
            } catch (error) {
                console.error('数据存储系统初始化失败:', error);
                // 降级到基本的localStorage模式
                DataStorage.useIndexedDB = false;
                await initializeBasicStorage();
            }
        }
        
        /**
         * 基本存储初始化（降级模式）
         */
        async function initializeBasicStorage() {
            console.log('使用基本存储模式');
            
            state.chats = await DataStorage.load(DataStorage.KEYS.CHATS, {});
            state.globalSettings.apiSettings = await DataStorage.load(DataStorage.KEYS.API_SETTINGS, {});
            state.globalSettings.appearanceSettings = await DataStorage.load(DataStorage.KEYS.APPEARANCE_SETTINGS, {});
            state.globalSettings.fontSettings = await DataStorage.load(DataStorage.KEYS.FONT_SETTINGS, {});
            state.globalSettings.qzoneSettings = await DataStorage.load(DataStorage.KEYS.QZONE_SETTINGS, {});
            state.qzonePosts = await DataStorage.load(DataStorage.KEYS.QZONE_POSTS, []);
            state.worldBooks = await DataStorage.load(DataStorage.KEYS.WORLD_BOOKS, []);
            
            updateStorageFunctions();
            DataSync.startAutoSave();
        }
        
        /**
         * 执行数据迁移
         */
        async function performDataMigration() {
            try {
                const migrationVersion = await DataStorage.load('migrationVersion', '1.0');
                
                if (migrationVersion === '1.0' && DataStorage.useIndexedDB) {
                    console.log('执行数据迁移到IndexedDB...');
                    
                    // 迁移聊天数据
                    const chats = state.chats;
                    if (chats && typeof chats === 'object') {
                        for (const [chatId, chat] of Object.entries(chats)) {
                            if (chat.history && Array.isArray(chat.history)) {
                                // 将消息历史迁移到独立的messages存储
                                for (const message of chat.history) {
                                    message.chatId = chatId;
                                    if (!message.id) {
                                        message.id = DataStorage.generateId();
                                    }
                                    await DataStorage.add(DataStorage.KEYS.MESSAGES, message);
                                }
                                
                                // 清理聊天对象中的历史记录
                                delete chat.history;
                            }
                            
                            // 确保聊天对象有必要的字段
                            chat.id = chatId;
                            chat.createdAt = chat.createdAt || Date.now();
                            chat.updatedAt = Date.now();
                            
                            await DataStorage.add(DataStorage.KEYS.CHATS, chat);
                        }
                    }
                    
                    // 更新迁移版本
                    await DataStorage.save('migrationVersion', '2.0');
                    console.log('数据迁移完成');
                }
            } catch (error) {
                console.error('数据迁移失败:', error);
            }
        }
        
        /**
         * 绑定所有事件
         */
        function bindAllEvents() {
            bindNavigationEvents();
            bindUserAvatarEvents();
            bindChatTypeToggleEvents();
            bindAddMenuEvents();
            bindChatInterfaceEvents();
            bindAPISettingsEvents();
            bindAppearanceSettingsEvents();
            bindFontSettingsEvents();
            bindWorldBookEvents();
            bindChatHistoryEvents();
            console.log('事件绑定完成');
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('聊天应用复刻版启动');
            
            // 初始化数据存储系统
            await initializeDataStorage();
            
            // 初始化数据和界面
            initializeSampleData();
            initializeAPISettings();
            initializeAppearanceSettings();
            initializeFontSettings();
            initializeWorldBooks();
            initializeScreens();
            bindAllEvents();
            
            // 渲染聊天列表
            renderChatList();
            
            console.log('应用初始化完成');
        });
    </script>
</body>
</html>